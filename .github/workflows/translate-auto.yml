name: "Translate: Auto-update"

# Automatically update translations when English content or prompts change
on:
  push:
    branches:
      - master
    paths:
      - "docs/en/docs/**/*.md"
      - "docs/*/llm-prompt.md"
      - "_scripts/general-llm-prompt.md"

  # Allow manual trigger
  workflow_dispatch:

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      languages: ${{ steps.check.outputs.languages }}
      has_outdated: ${{ steps.check.outputs.has_outdated }}
      fix_languages: ${{ steps.check.outputs.fix_languages }}
      has_prompt_changes: ${{ steps.check.outputs.has_prompt_changes }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - uses: astral-sh/setup-uv@v4

      - name: Check for outdated translations and prompt changes
        id: check
        working-directory: _scripts
        run: |
          # Discover all translation languages (all language dirs except 'en')
          all_languages=$(find ../docs -maxdepth 2 -name "mkdocs.yml" -exec dirname {} \; | xargs -n1 basename | sort | grep -v '^en$' | tr '\n' ' ')
          echo "All translation languages: $all_languages"

          # Check if general prompt changed (affects all languages)
          general_prompt_changed="false"
          if [ "${{ github.event_name }}" = "push" ]; then
            changed_files=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} 2>/dev/null || echo "")
            if echo "$changed_files" | grep -q '_scripts/general-llm-prompt.md'; then
              echo "General prompt changed - all languages need fixing"
              general_prompt_changed="true"
            fi
          fi

          # Check which language-specific prompts changed
          langs_with_prompt_changes=""
          if [ "${{ github.event_name }}" = "push" ]; then
            for lang in $all_languages; do
              if echo "$changed_files" | grep -q "docs/${lang}/llm-prompt.md"; then
                echo "Prompt changed for $lang"
                if [ -n "$langs_with_prompt_changes" ]; then
                  langs_with_prompt_changes="$langs_with_prompt_changes,$lang"
                else
                  langs_with_prompt_changes="$lang"
                fi
              fi
            done
          fi

          # Check each language for outdated translations (English source newer than translation)
          languages_with_outdated=""
          for lang in $all_languages; do
            outdated=$(uv run translate.py list-outdated "$lang" 2>/dev/null | grep -c "docs/" || echo "0")
            if [ "$outdated" -gt 0 ]; then
              echo "Found $outdated outdated files for $lang"
              if [ -n "$languages_with_outdated" ]; then
                languages_with_outdated="$languages_with_outdated,$lang"
              else
                languages_with_outdated="$lang"
              fi
            fi
          done

          # Determine languages needing prompt fixes
          if [ "$general_prompt_changed" = "true" ]; then
            # All languages need fixing
            langs_needing_fix=$(echo "$all_languages" | tr ' ' ',' | sed 's/,$//')
          else
            langs_needing_fix="$langs_with_prompt_changes"
          fi

          # Output results
          echo "general_prompt_changed=$general_prompt_changed" >> $GITHUB_OUTPUT
          echo "langs_needing_fix=$langs_needing_fix" >> $GITHUB_OUTPUT

          if [ -n "$languages_with_outdated" ]; then
            echo "Languages with outdated translations: $languages_with_outdated"
            echo "has_outdated=true" >> $GITHUB_OUTPUT
            json_array=$(echo "$languages_with_outdated" | sed 's/,/","/g' | sed 's/^/["/' | sed 's/$/"]/')
            echo "languages=$json_array" >> $GITHUB_OUTPUT
          else
            echo "No outdated translations found"
            echo "has_outdated=false" >> $GITHUB_OUTPUT
            echo "languages=[]" >> $GITHUB_OUTPUT
          fi

          if [ -n "$langs_needing_fix" ]; then
            echo "Languages needing prompt fixes: $langs_needing_fix"
            echo "has_prompt_changes=true" >> $GITHUB_OUTPUT
            json_array=$(echo "$langs_needing_fix" | sed 's/,/","/g' | sed 's/^/["/' | sed 's/$/"]/')
            echo "fix_languages=$json_array" >> $GITHUB_OUTPUT
          else
            echo "No prompt changes detected"
            echo "has_prompt_changes=false" >> $GITHUB_OUTPUT
            echo "fix_languages=[]" >> $GITHUB_OUTPUT
          fi

  update-translations:
    needs: detect-changes
    if: needs.detect-changes.outputs.has_outdated == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 2 # Limit parallel API calls
      matrix:
        language: ${{ fromJson(needs.detect-changes.outputs.languages) }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - uses: astral-sh/setup-uv@v4

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Update outdated translations
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        working-directory: _scripts
        run: |
          echo "Updating outdated translations for ${{ matrix.language }}..."
          uv run translate.py update-outdated --language ${{ matrix.language }}

      - name: Check for changes
        id: changes
        run: |
          if [ -n "$(git status --porcelain docs/${{ matrix.language }}/)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.changes.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          LANG="${{ matrix.language }}"
          BRANCH="auto-translate-${LANG}-$(date +%Y%m%d-%H%M%S)"

          git checkout -b "$BRANCH"
          git add "docs/${LANG}/"
          git commit -m "Update ${LANG} translations to match latest English content"
          git push origin "$BRANCH"

          gh pr create \
            --title "Update ${{ matrix.language }} translations" \
            --body "$(cat <<EOF
          ## Automatic Translation Update

          This PR updates **${{ matrix.language }}** translations to match recent changes in English source files.

          ### Review Checklist
          - [ ] Verify technical terms are correctly translated
          - [ ] Check that code blocks remain in English
          - [ ] Confirm admonition titles match the glossary
          - [ ] Test the build passes

          ---
          *This PR was automatically created by the translation workflow.*
          EOF
          )" \
            --base master \
            --head "$BRANCH"

  # Fix existing translations when prompt guidelines change
  fix-translations:
    needs: detect-changes
    if: needs.detect-changes.outputs.has_prompt_changes == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 1 # Process one language at a time to avoid API rate limits
      matrix:
        language: ${{ fromJson(needs.detect-changes.outputs.fix_languages) }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - uses: astral-sh/setup-uv@v4

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Fix translations for updated prompt
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        working-directory: _scripts
        run: |
          echo "Fixing ${{ matrix.language }} translations to comply with updated prompt guidelines..."
          uv run translate.py fix-translations --language ${{ matrix.language }} --max-iterations 8

      - name: Check for changes
        id: changes
        run: |
          if [ -n "$(git status --porcelain docs/${{ matrix.language }}/)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.changes.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          LANG="${{ matrix.language }}"
          BRANCH="fix-translations-${LANG}-$(date +%Y%m%d-%H%M%S)"

          git checkout -b "$BRANCH"
          git add "docs/${LANG}/"
          git commit -m "Fix ${LANG} translations to comply with updated prompt guidelines"
          git push origin "$BRANCH"

          gh pr create \
            --title "Fix ${{ matrix.language }} translations for updated prompt" \
            --body "$(cat <<EOF
          ## Translation Prompt Update

          This PR fixes **${{ matrix.language }}** translations to comply with updated prompt guidelines.

          The translation prompt was updated and existing translations needed to be reviewed and corrected to match the new guidelines.

          ### What Changed
          The fix-translations command ran multiple passes to ensure all translations comply with:
          - Updated terminology rules
          - Tone and style guidelines
          - Capitalization rules
          - Other prompt-specific requirements

          ### Review Checklist
          - [ ] Verify changes align with the updated prompt
          - [ ] Check that code blocks remain unchanged
          - [ ] Confirm the build passes

          ---
          *This PR was automatically created by the translation workflow in response to prompt changes.*
          EOF
          )" \
            --base master \
            --head "$BRANCH"
