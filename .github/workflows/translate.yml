name: Translate

on:
  workflow_dispatch:
    inputs:
      language:
        description: "Language code (any language directory under docs/ except 'en')"
        required: true
        type: string
      command:
        description: "Command to run"
        required: true
        default: "list-outdated"
        type: choice
        options:
          - list-outdated
          - list-missing
          - update-outdated
          - add-missing
          - update-and-add

jobs:
  translate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history needed for git timestamp comparison

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - uses: astral-sh/setup-uv@v4

      - name: Validate language
        run: |
          LANG="${{ inputs.language }}"
          if [ "$LANG" = "en" ]; then
            echo "Error: Cannot translate English (source language)"
            exit 1
          fi
          if [ ! -d "docs/$LANG" ] || [ ! -f "docs/$LANG/mkdocs.yml" ]; then
            echo "Error: Language '$LANG' not found. Available languages:"
            find docs -maxdepth 2 -name "mkdocs.yml" -exec dirname {} \; | xargs -n1 basename | sort | grep -v '^en$'
            exit 1
          fi
          echo "Language '$LANG' validated"

      - name: Run translation command
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          LANGUAGE: ${{ inputs.language }}
          COMMAND: ${{ inputs.command }}
        working-directory: _scripts
        run: |
          case "$COMMAND" in
            list-outdated)
              uv run translate.py list-outdated "$LANGUAGE"
              ;;
            list-missing)
              uv run translate.py list-missing "$LANGUAGE"
              ;;
            update-outdated)
              uv run translate.py update-outdated --language "$LANGUAGE"
              ;;
            add-missing)
              uv run translate.py add-missing --language "$LANGUAGE"
              ;;
            update-and-add)
              uv run translate.py update-and-add --language "$LANGUAGE"
              ;;
          esac

      - name: Fix translations
        if: inputs.command == 'update-outdated' || inputs.command == 'add-missing' || inputs.command == 'update-and-add'
        working-directory: _scripts
        run: uv run translation_fixer.py fix-all ${{ inputs.language }}

      - name: Create PR with changes
        if: inputs.command == 'update-outdated' || inputs.command == 'add-missing' || inputs.command == 'update-and-add'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          LANGUAGE: ${{ inputs.language }}
          COMMAND: ${{ inputs.command }}
        working-directory: _scripts
        run: |
          uv run translate.py make-pr \
            --language "$LANGUAGE" \
            --command "$COMMAND" \
            --github-token "$GITHUB_TOKEN" \
            --github-repository "$GITHUB_REPOSITORY"
