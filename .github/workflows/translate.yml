name: Translate

on:
  # Automatic: when English content or prompts change
  push:
    branches:
      - master
    paths:
      - "docs/en/docs/**/*.md"
      - "docs/*/llm-prompt.md"
      - "_scripts/general-llm-prompt.md"

  # Manual trigger
  workflow_dispatch:
    inputs:
      language:
        description: "Language code (empty = all)"
        type: string
      dry_run:
        description: "Dry run (preview only)"
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write

jobs:
  detect:
    runs-on: ubuntu-latest
    outputs:
      languages: ${{ steps.detect.outputs.languages }}
      has_work: ${{ steps.detect.outputs.has_work }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: astral-sh/setup-uv@v4

      - name: Detect work
        id: detect
        working-directory: _scripts
        run: |
          uv run -q translate.py ci-detect \
            ${{ inputs.language && format('--language "{0}"', inputs.language) || '' }} \
            >> $GITHUB_OUTPUT

  translate:
    needs: detect
    if: needs.detect.outputs.has_work == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false # Continue other languages if one fails
      matrix:
        language: ${{ fromJson(needs.detect.outputs.languages) }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: astral-sh/setup-uv@v4

      - name: Translate ${{ matrix.language }}
        if: ${{ !inputs.dry_run }}
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        working-directory: _scripts
        run: uv run -q translate.py sync ${{ matrix.language }}

      - name: Dry run ${{ matrix.language }}
        if: ${{ inputs.dry_run }}
        working-directory: _scripts
        run: uv run -q translate.py sync ${{ matrix.language }} --dry-run

      - name: Upload translation artifacts
        if: ${{ !inputs.dry_run && success() }}
        uses: actions/upload-artifact@v4
        with:
          name: translation-${{ matrix.language }}
          path: docs/${{ matrix.language }}/docs/
          retention-days: 1
          if-no-files-found: ignore

  merge:
    needs: [detect, translate]
    if: always() && needs.detect.outputs.has_work == 'true' && !inputs.dry_run && !cancelled()
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download all translation artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: translation-*
          path: artifacts/

      - name: Check for artifacts
        id: check
        run: |
          if [ -z "$(ls -A artifacts/ 2>/dev/null)" ]; then
            echo "has_artifacts=false" >> $GITHUB_OUTPUT
            echo "No translation artifacts found"
          else
            echo "has_artifacts=true" >> $GITHUB_OUTPUT
            echo "Found translations for:"
            ls artifacts/ | sed 's/translation-/  - /'
          fi

      - name: Merge translations
        if: steps.check.outputs.has_artifacts == 'true'
        run: |
          for dir in artifacts/translation-*/; do
            lang=$(basename "$dir" | sed 's/translation-//')
            echo "Merging $lang..."
            mkdir -p "docs/$lang/docs/"
            cp -r "$dir"* "docs/$lang/docs/"
          done

      - uses: astral-sh/setup-uv@v4
        if: steps.check.outputs.has_artifacts == 'true'

      - name: Create PR
        if: steps.check.outputs.has_artifacts == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        working-directory: _scripts
        run: uv run -q translate.py ci-pr
