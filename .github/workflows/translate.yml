name: Translate

on:
  # Automatic: when English content or prompts change
  push:
    branches:
      - master
    paths:
      - "docs/en/docs/**/*.md"
      - "docs/*/llm-prompt.md"
      - "_scripts/general-llm-prompt.md"

  # Manual trigger
  workflow_dispatch:
    inputs:
      language:
        description: "Language code (empty = all)"
        type: string
      dry_run:
        description: "Dry run (preview only)"
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write

jobs:
  detect:
    runs-on: ubuntu-latest
    outputs:
      languages: ${{ steps.detect.outputs.languages }}
      has_work: ${{ steps.detect.outputs.has_work }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: astral-sh/setup-uv@v4

      - name: Detect work
        id: detect
        working-directory: _scripts
        run: |
          uv run translate.py ci-detect \
            ${{ inputs.language && format('--language "{0}"', inputs.language) || '' }} \
            >> $GITHUB_OUTPUT

  translate:
    needs: detect
    if: needs.detect.outputs.has_work == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: astral-sh/setup-uv@v4

      - name: Run translation
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        working-directory: _scripts
        run: |
          uv run translate.py ci-run \
            --languages '${{ needs.detect.outputs.languages }}' \
            ${{ inputs.dry_run && '--dry-run' || '' }}

      - name: Create PR
        if: ${{ !inputs.dry_run }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        working-directory: _scripts
        run: |
          uv run translate.py ci-pr
