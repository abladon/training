# рднрд╛рдЧ 4: рдЯреЗрд╕реНрдЯ рдЬреЛрдбрд╝рдирд╛

<span class="ai-translation-notice">:material-information-outline:{ .ai-translation-notice-icon } AI-рд╕рд╣рд╛рдпрддрд╛ рдкреНрд░рд╛рдкреНрдд рдЕрдиреБрд╡рд╛рдж - [рдЕрдзрд┐рдХ рдЬрд╛рдиреЗрдВ рдФрд░ рд╕реБрдзрд╛рд░ рд╕реБрдЭрд╛рдПрдВ](https://github.com/nextflow-io/training/blob/master/TRANSLATING.md)</span>

рдЗрд╕ рдХреЛрд░реНрд╕ рдХреЗ рдкрд╣рд▓реЗ рднрд╛рдЧ рдореЗрдВ, рдЖрдкрдиреЗ рдПрдХ variant calling pipeline рдмрдирд╛рдИ рдЬреЛ рдкреВрд░реА рддрд░рд╣ рд╕реЗ linear рдереА рдФрд░ рдкреНрд░рддреНрдпреЗрдХ рдирдореВрдиреЗ рдХреЗ рдбреЗрдЯрд╛ рдХреЛ рджреВрд╕рд░реЛрдВ рд╕реЗ рд╕реНрд╡рддрдВрддреНрд░ рд░реВрдк рд╕реЗ рдкреНрд░реЛрд╕реЗрд╕ рдХрд░рддреА рдереАред

рджреВрд╕рд░реЗ рднрд╛рдЧ рдореЗрдВ, рд╣рдордиреЗ рдЖрдкрдХреЛ рджрд┐рдЦрд╛рдпрд╛ рдХрд┐ GATK рдХреЗ рд╕рд╛рде joint variant calling рдХреЛ рд▓рд╛рдЧреВ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП channels рдФрд░ channel operators рдХрд╛ рдЙрдкрдпреЛрдЧ рдХреИрд╕реЗ рдХрд░реЗрдВред

рддреАрд╕рд░реЗ рднрд╛рдЧ рдореЗрдВ, рд╣рдордиреЗ pipeline рдХреЛ modularize рдХрд┐рдпрд╛ред

рдкреНрд░рд╢рд┐рдХреНрд╖рдг рдХреЗ рдЗрд╕ рднрд╛рдЧ рдореЗрдВ, рд╣рдо рдЖрдкрдХреЛ рджрд┐рдЦрд╛рдиреЗ рдЬрд╛ рд░рд╣реЗ рд╣реИрдВ рдХрд┐ [**nf-test**](https://www.nf-test.com/) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХреИрд╕реЗ рдХрд░реЗрдВ, рдПрдХ testing framework рдЬреЛ Nextflow рдХреЗ рд╕рд╛рде рдЕрдЪреНрдЫреА рддрд░рд╣ integrate рд╣реЛрддрд╛ рд╣реИ рдФрд░ рдЖрдкрдХреА pipeline рдореЗрдВ module-level рдФрд░ workflow-level рджреЛрдиреЛрдВ рдкреНрд░рдХрд╛рд░ рдХреЗ рдЯреЗрд╕реНрдЯ рдЬреЛрдбрд╝рдирд╛ рд╕рд░рд▓ рдмрдирд╛рддрд╛ рд╣реИред рдкреНрд░рд╢рд┐рдХреНрд╖рдг рдХреЗ рдЗрд╕ рднрд╛рдЧ рдХрд╛ рдкрд╛рд▓рди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдЖрдкрдХреЛ рднрд╛рдЧ 1, рднрд╛рдЧ 2, рдФрд░ рднрд╛рдЧ 3 рдХреЗ рд╕рд╛рде-рд╕рд╛рде [nf-test side quest](../../side_quests/nf-test.md) рдкреВрд░рд╛ рдХрд░рдирд╛ рдЪрд╛рд╣рд┐рдП, рдЬреЛ nf-test рдХреА рдореВрд▓ рдмрд╛рддреЗрдВ рдФрд░ testing рдХреНрдпреЛрдВ рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╣реИ, рдЗрд╕ рдкрд░ рдЖрдзрд╛рд░рд┐рдд рд╣реИред

---

## 0. Warmup

!!! note

    рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░реЗрдВ рдХрд┐ рдЖрдк рд╕рд╣реА working рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рдореЗрдВ рд╣реИрдВ:
    `cd /workspaces/training/nf4-science/genomics`

рдпрджрд┐ рдЖрдкрдиреЗ рдЗрд╕ рдкреНрд░рд╢рд┐рдХреНрд╖рдг рдХреЛрд░реНрд╕ рдХреЗ рдкрд┐рдЫрд▓реЗ рднрд╛рдЧреЛрдВ рдХреЛ рдкреВрд░рд╛ рдХрд┐рдпрд╛ рд╣реИ, рддреЛ рдЖрдкрдХреЗ рдкрд╛рд╕ рдЙрдЪрд┐рдд modules рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рд╕рдВрд░рдЪрдирд╛ рдХреЗ рд╕рд╛рде genomics pipeline рдХрд╛ рдПрдХ working рд╕рдВрд╕реНрдХрд░рдг рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдПред

??? abstract "рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рдХреА рд╕рд╛рдордЧреНрд░реА"

    ```console
    modules/
    тФЬтФАтФА gatk
    тФВ   тФЬтФАтФА haplotypecaller
    тФВ   тФВ   тФФтФАтФА main.nf
    тФВ   тФФтФАтФА jointgenotyping
    тФВ       тФФтФАтФА main.nf
    тФФтФАтФА samtools
        тФФтФАтФА index
            тФФтФАтФА main.nf
    ```

рдпрд╣ modules рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА `solutions` рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рдореЗрдВ рдкрд╛рдИ рдЬрд╛ рд╕рдХрддреА рд╣реИ рдпрджрд┐ рдЖрдкрдХреЛ рдЗрд╕рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛред

рд╣рдо рднрд╛рдЧ 3 рдореЗрдВ рдЬреИрд╕реА рд╣реА workflow рдХреЗ рд╕рд╛рде рд╢реБрд░реВ рдХрд░рдиреЗ рдЬрд╛ рд░рд╣реЗ рд╣реИрдВ, рдЬрд┐рд╕реЗ рд╣рдордиреЗ рдЖрдкрдХреЗ рд▓рд┐рдП `genomics-4.nf` рдлрд╝рд╛рдЗрд▓ рдореЗрдВ рдкреНрд░рджрд╛рди рдХрд┐рдпрд╛ рд╣реИред [nf-test side quest](../../side_quests/nf-test.md) рдХреА рддрд░рд╣ рд╣реА, рд╣рдо рдЗрд╕ pipeline рдореЗрдВ рддреАрди processes рдХреЗ рд▓рд┐рдП рдХреБрдЫ рдЕрд▓рдЧ-рдЕрд▓рдЧ рдкреНрд░рдХрд╛рд░ рдХреЗ рдЯреЗрд╕реНрдЯ рдЬреЛрдбрд╝рдиреЗ рдЬрд╛ рд░рд╣реЗ рд╣реИрдВ, рд╕рд╛рде рд╣реА рдПрдХ workflow-level рдЯреЗрд╕реНрдЯ рднреАред

### 0.1. рдЬрд╛рдВрдЪреЗрдВ рдХрд┐ workflow рдЪрд▓рддреА рд╣реИ

рдЯреЗрд╕реНрдЯ рдЬреЛрдбрд╝рдирд╛ рд╢реБрд░реВ рдХрд░рдиреЗ рд╕реЗ рдкрд╣рд▓реЗ, рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░реЗрдВ рдХрд┐ workflow рдЕрдкреЗрдХреНрд╖рд╛ рдХреЗ рдЕрдиреБрд╕рд╛рд░ рдЪрд▓рддреА рд╣реИред

```bash
nextflow run genomics-4.nf -resume
```

рдпрджрд┐ рдЖрдк рдЗрд╕ рдкреНрд░рд╢рд┐рдХреНрд╖рдг рдХреЛрд░реНрд╕ рдХреЛ рд╢реБрд░реВ рд╕реЗ рдХрд░ рд░рд╣реЗ рд╣реИрдВ рддреЛ рдпрд╣ рдЕрдм рддрдХ рдмрд╣реБрдд рдкрд░рд┐рдЪрд┐рдд рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдПред

??? success "рдХрдорд╛рдВрдб рдЖрдЙрдЯрдкреБрдЯ"

    ```console
    N E X T F L O W   ~  version 25.10.2

    Launching `genomics-4.nf` [gloomy_poincare] DSL2 - revision: 43203316e0

    executor >  local (7)
    [18/89dfa4] SAMTOOLS_INDEX (1)       | 3 of 3 тЬФ
    [30/b2522b] GATK_HAPLOTYPECALLER (2) | 3 of 3 тЬФ
    [a8/d2c189] GATK_JOINTGENOTYPING     | 1 of 1 тЬФ
    ```

рдкрд╣рд▓реЗ рдХреА рддрд░рд╣, рдЕрдм рдЖрдкрдХреА project рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рдХреЗ рдЕрдВрджрд░ рдПрдХ `work` рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рдФрд░ рдПрдХ `results_genomics` рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рд╣реЛрдЧреАред рд╣рдо рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ рдЗрди рдкрд░рд┐рдгрд╛рдореЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдмрд╛рдж рдореЗрдВ рдЕрдкрдиреА testing рдореЗрдВ рдХрд░реЗрдВрдЧреЗред рд▓реЗрдХрд┐рди рдЕрдм рд╕реЗ рд╣рдо pipeline рдХреЛ рдЯреЗрд╕реНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП `nf-test` package рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдЬрд╛ рд░рд╣реЗ рд╣реИрдВред

### 0.2. `nf-test` рдХреЛ initialize рдХрд░реЗрдВ

[nf-test side quest](../../side_quests/nf-test.md) рдХреА рддрд░рд╣, рд╣рдореЗрдВ `nf-test` package рдХреЛ initialize рдХрд░рдирд╛ рд╣реЛрдЧрд╛ред

```bash
nf-test init
```

??? success "рдХрдорд╛рдВрдб рдЖрдЙрдЯрдкреБрдЯ"

    ```console
    ЁЯЪА nf-test 0.9.3
    https://www.nf-test.com
    (c) 2021 - 2024 Lukas Forer and Sebastian Schoenherr

    Project configured. Configuration is stored in nf-test.config
    ```

??? abstract "nf-test.config рдХреА рд╕рд╛рдордЧреНрд░реА"

    ```groovy title="nf-test.config"
    config {

        testsDir "tests"
        workDir ".nf-test"
        configFile "tests/nextflow.config"
        profile ""

    }
    ```

рдпрд╣ рдПрдХ configuration рдлрд╝рд╛рдЗрд▓ stub рдпреБрдХреНрдд `tests` рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рднреА рдмрдирд╛рддрд╛ рд╣реИред

### рдирд┐рд╖реНрдХрд░реНрд╖

рдЕрдм рд╣рдо рдЕрдкрдиреА genomics pipeline рдХреЗ рд▓рд┐рдП рдЯреЗрд╕реНрдЯ рд▓рд┐рдЦрдиреЗ рдХреЗ рд▓рд┐рдП рддреИрдпрд╛рд░ рд╣реИрдВред

### рдЖрдЧреЗ рдХреНрдпрд╛ рд╣реИ?

рдореВрд▓ рдЯреЗрд╕реНрдЯ рд▓рд┐рдЦреЗрдВ рдЬреЛ рдореВрд▓реНрдпрд╛рдВрдХрди рдХрд░рддреЗ рд╣реИрдВ рдХрд┐ process calls рд╕рдлрд▓ рд░рд╣реЗ рдФрд░ рд╕рд╣реА рдЖрдЙрдЯрдкреБрдЯ рдЙрддреНрдкрдиреНрди рд╣реБрдПред

---

## 1. рд╕рдлрд▓рддрд╛ рдФрд░ рдорд┐рд▓рд╛рди рдХрд░рддреЗ рдЖрдЙрдЯрдкреБрдЯ рдХреЗ рд▓рд┐рдП рдПрдХ process рдХреЛ рдЯреЗрд╕реНрдЯ рдХрд░реЗрдВ

рд╣рдо `SAMTOOLS_INDEX` process рдХреЛ рдЯреЗрд╕реНрдЯ рдХрд░рдХреЗ рд╢реБрд░реВ рдХрд░реЗрдВрдЧреЗ, рдЬреЛ рдХреБрд╢рд▓ random access рдХреЛ рд╕рдХреНрд╖рдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП BAM рдлрд╝рд╛рдЗрд▓реЛрдВ рдХреЗ рд▓рд┐рдП рдЗрдВрдбреЗрдХреНрд╕ рдлрд╝рд╛рдЗрд▓реЗрдВ рдмрдирд╛рддреА рд╣реИред рдпрд╣ рдПрдХ рдЕрдЪреНрдЫрд╛ рдкрд╣рд▓рд╛ рдЯреЗрд╕реНрдЯ рдХреЗрд╕ рд╣реИ рдХреНрдпреЛрдВрдХрд┐:

1. рдЗрд╕рдореЗрдВ рдПрдХ рдПрдХрд▓, рд╕реБрдкрд░рд┐рднрд╛рд╖рд┐рдд рдЗрдирдкреБрдЯ (рдПрдХ BAM рдлрд╝рд╛рдЗрд▓) рд╣реИ
2. рдпрд╣ рдПрдХ рдЕрдиреБрдорд╛рдирд┐рдд рдЖрдЙрдЯрдкреБрдЯ (рдПрдХ BAI рдЗрдВрдбреЗрдХреНрд╕ рдлрд╝рд╛рдЗрд▓) рдЙрддреНрдкрдиреНрди рдХрд░рддрд╛ рд╣реИ
3. рд╕рдорд╛рди рдЗрдирдкреБрдЯ рдХреЗ рд▓рд┐рдП рдЖрдЙрдЯрдкреБрдЯ рд╕рдорд╛рди рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП

### 1.1. рдПрдХ рдЯреЗрд╕реНрдЯ рдлрд╝рд╛рдЗрд▓ stub рдЙрддреНрдкрдиреНрди рдХрд░реЗрдВ

рд╕рдмрд╕реЗ рдкрд╣рд▓реЗ, рдПрдХ рдЯреЗрд╕реНрдЯ рдлрд╝рд╛рдЗрд▓ stub рдЙрддреНрдкрдиреНрди рдХрд░реЗрдВ:

```bash
nf-test generate process modules/samtools/index/main.nf
```

??? success "рдХрдорд╛рдВрдб рдЖрдЙрдЯрдкреБрдЯ"

    ```console
    Load source file '/workspaces/training/nf4-science/genomics/modules/samtools/index/main.nf'
    Wrote process test file '/workspaces/training/nf4-science/genomics/tests/modules/samtools/index/main.nf.test'

    SUCCESS: Generated 1 test files.
    ```

рдпрд╣ `main.nf` рдХреЗ рд╕рдорд╛рди рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рдореЗрдВ рдПрдХ рдлрд╝рд╛рдЗрд▓ рдмрдирд╛рддрд╛ рд╣реИред
рдЖрдк file explorer рдореЗрдВ рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рдкрд░ рдЬрд╛ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдлрд╝рд╛рдЗрд▓ рдЦреЛрд▓ рд╕рдХрддреЗ рд╣реИрдВ, рдЬрд┐рд╕рдореЗрдВ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХреЛрдб рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП:

```groovy title="tests/modules/samtools/index/main.nf.test" linenums="1"
nextflow_process {

    name "Test Process SAMTOOLS_INDEX"
    script "modules/samtools/index/main.nf"
    process "SAMTOOLS_INDEX"

    test("Should run without failures") {

        when {
            params {
                // define parameters here. Example:
                // outdir = "tests/results"
            }
            process {
                """
                // define inputs of the process here. Example:
                // input[0] = file("test-file.txt")
                """
            }
        }

        then {
            assert process.success
            assert snapshot(process.out).match()
        }

    }

}
```

рд╢реБрд░реБрдЖрддреА assertions [nf-test side quest](../../side_quests/nf-test.md) рд╕реЗ рдкрд░рд┐рдЪрд┐рдд рд╣реЛрдиреЗ рдЪрд╛рд╣рд┐рдП:

- `assert process.success` рдХрд╣рддрд╛ рд╣реИ рдХрд┐ рд╣рдо рдЙрдореНрдореАрдж рдХрд░рддреЗ рд╣реИрдВ рдХрд┐ process рд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ рдЪрд▓реЗ рдФрд░ рдмрд┐рдирд╛ рдХрд┐рд╕реА рд╡рд┐рдлрд▓рддрд╛ рдХреЗ рдкреВрд░рд╛ рд╣реЛред
- `snapshot(process.out).match()` рдХрд╣рддрд╛ рд╣реИ рдХрд┐ рд╣рдо рдЙрдореНрдореАрдж рдХрд░рддреЗ рд╣реИрдВ рдХрд┐ рд░рди рдХрд╛ рдкрд░рд┐рдгрд╛рдо рдкрд┐рдЫрд▓реЗ рд░рди рдореЗрдВ рдкреНрд░рд╛рдкреНрдд рдкрд░рд┐рдгрд╛рдо (рдпрджрд┐ рд▓рд╛рдЧреВ рд╣реЛ) рдХреЗ рд╕рдорд╛рди рд╣реЛред
  рд╣рдо рдЗрд╕ рдкрд░ рдмрд╛рдж рдореЗрдВ рдЕрдзрд┐рдХ рд╡рд┐рд╕реНрддрд╛рд░ рд╕реЗ рдЪрд░реНрдЪрд╛ рдХрд░рддреЗ рд╣реИрдВред

рдЗрд╕реЗ рдПрдХ рд╢реБрд░реБрдЖрддреА рдмрд┐рдВрджреБ рдХреЗ рд░реВрдк рдореЗрдВ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реБрдП, рд╣рдореЗрдВ samtools index process рдХреЗ рд▓рд┐рдП рд╕рд╣реА рдЯреЗрд╕реНрдЯ рдЗрдирдкреБрдЯ рдЬреЛрдбрд╝рдиреЗ рд╣реЛрдВрдЧреЗ, рдФрд░ рдпрджрд┐ рд▓рд╛рдЧреВ рд╣реЛ рддреЛ рдХреЛрдИ рднреА рдкреИрд░рд╛рдореАрдЯрд░ред

### 1.2. рдЯреЗрд╕реНрдЯ рдлрд╝рд╛рдЗрд▓ рдХреЛ рд╕реНрдерд╛рдирд╛рдВрддрд░рд┐рдд рдХрд░реЗрдВ рдФрд░ script path рдХреЛ рдЕрдкрдбреЗрдЯ рдХрд░реЗрдВ

рдЯреЗрд╕реНрдЯ рдХреЛ рднрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд╛рдо рдХрд░рдиреЗ рд╕реЗ рдкрд╣рд▓реЗ, рд╣рдореЗрдВ рдлрд╝рд╛рдЗрд▓ рдХреЛ рдЙрд╕рдХреЗ рдирд┐рд╢реНрдЪрд┐рдд рд╕реНрдерд╛рди рдкрд░ рд▓реЗ рдЬрд╛рдирд╛ рд╣реЛрдЧрд╛ред рд╣рдордиреЗ рдкреНрд░рддреНрдпреЗрдХ рдореЙрдбреНрдпреВрд▓ рдХреЗ рд▓рд┐рдП рдПрдХ рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рдЬреЛрдбрд╝рдиреЗ рдХрд╛ рдПрдХ рдХрд╛рд░рдг рдпрд╣ рд╣реИ рдХрд┐ рдЕрдм рд╣рдо рдкреНрд░рддреНрдпреЗрдХ рдореЙрдбреНрдпреВрд▓ рдХреА `main.nf` рдлрд╝рд╛рдЗрд▓ рдХреЗ рд╕рд╛рде co-located `tests` рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рдореЗрдВ рдЯреЗрд╕реНрдЯ ship рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рд╡рд╣ рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рдмрдирд╛рдПрдВ рдФрд░ рдЯреЗрд╕реНрдЯ рдлрд╝рд╛рдЗрд▓ рдХреЛ рд╡рд╣рд╛рдБ рд▓реЗ рдЬрд╛рдПрдВред

```bash
mkdir -p modules/samtools/index/tests
mv tests/modules/samtools/index/main.nf.test modules/samtools/index/tests/
```

рдЕрдм рд╣рдо рдЯреЗрд╕реНрдЯ рдлрд╝рд╛рдЗрд▓ рдХреЗ `script` рд╕реЗрдХреНрд╢рди рдХреЛ рдПрдХ relative path рдореЗрдВ рд╕рд░рд▓ рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВ:

=== "рдмрд╛рдж рдореЗрдВ"

    ```groovy title="modules/samtools/index/tests/main.nf.test" linenums="3" hl_lines="2"
    name "Test Process SAMTOOLS_INDEX"
    script "../main.nf"
    process "SAMTOOLS_INDEX"
    ```

=== "рдкрд╣рд▓реЗ"

    ```groovy title="modules/samtools/index/tests/main.nf.test" linenums="3" hl_lines="2"
    name "Test Process SAMTOOLS_INDEX"
    script "modules/samtools/index/main.nf"
    process "SAMTOOLS_INDEX"
    ```

рдпрд╣ рдЯреЗрд╕реНрдЯ рдХреЛ рдмрддрд╛рддрд╛ рд╣реИ рдХрд┐ рдореЙрдбреНрдпреВрд▓ рдХреА `main.nf` рдлрд╝рд╛рдЗрд▓ рдХрд╣рд╛рдБ рдЦреЛрдЬрдиреА рд╣реИ, рдкреВрд░рд╛ path рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд┐рдП рдмрд┐рдирд╛ред

### 1.3. SAMTOOLS_INDEX рдХреЗ рд▓рд┐рдП рдЯреЗрд╕реНрдЯ рдЗрдирдкреБрдЯ рдкреНрд░рджрд╛рди рдХрд░реЗрдВ

stub рдлрд╝рд╛рдЗрд▓ рдореЗрдВ рдПрдХ placeholder рд╢рд╛рдорд┐рд▓ рд╣реИ рдЬрд┐рд╕реЗ рд╣рдореЗрдВ `samtools index` рдХреЗ рдЗрдирдкреБрдЯ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреБрдХреНрдд рд╡рд╛рд╕реНрддрд╡рд┐рдХ рдЯреЗрд╕реНрдЯ рдЗрдирдкреБрдЯ рд╕реЗ рдмрджрд▓рдирд╛ рд╣реЛрдЧрд╛ред рдЙрдкрдпреБрдХреНрдд рдЗрдирдкреБрдЯ рдПрдХ BAM рдлрд╝рд╛рдЗрд▓ рд╣реИ, рдЬреЛ рд╣рдорд╛рд░реЗ рдкрд╛рд╕ `data/bam` рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рдореЗрдВ рдЙрдкрд▓рдмреНрдз рд╣реИред

=== "рдмрд╛рдж рдореЗрдВ"

    ```groovy title="modules/samtools/index/tests/main.nf.test" linenums="14"
    process {
        """
        input[0] = file("${projectDir}/data/bam/reads_son.bam")
        """
    }
    ```

=== "рдкрд╣рд▓реЗ"

    ```groovy title="modules/samtools/index/tests/main.nf.test" linenums="14"
    process {
        """
        // define inputs of the process here. Example:
        // input[0] = file("test-file.txt")
        """
    }
    ```

### 1.4. рдХрд╛рд░реНрдпрдХреНрд╖рдорддрд╛ рдХреЗ рдЖрдзрд╛рд░ рдкрд░ рдЯреЗрд╕реНрдЯ рдХрд╛ рдирд╛рдо рджреЗрдВ

рдЬреИрд╕рд╛ рдХрд┐ рд╣рдордиреЗ рдкрд╣рд▓реЗ рд╕реАрдЦрд╛, рдЯреЗрд╕реНрдЯ рдХрд╛ рдирд╛рдо рдмрджрд▓рдирд╛ рдЕрдЪреНрдЫрд╛ рдЕрднреНрдпрд╛рд╕ рд╣реИ рддрд╛рдХрд┐ рдпрд╣ рдЯреЗрд╕реНрдЯ рдХреЗ рд╕рдВрджрд░реНрдн рдореЗрдВ рд╕рдордЭ рдореЗрдВ рдЖрдПред

=== "рдмрд╛рдж рдореЗрдВ"

    ```groovy title="modules/samtools/index/tests/main.nf.test" linenums="7"
    test("Should index reads_son.bam correctly") {
    ```

    рдпрд╣ рдПрдХ arbitrary string рд▓реЗрддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рд╣рдо рдЬреЛ рдЪрд╛рд╣реЗрдВ рдбрд╛рд▓ рд╕рдХрддреЗ рд╣реИрдВред
    рдпрд╣рд╛рдВ рд╣рдо рдлрд╝рд╛рдЗрд▓ рдирд╛рдо рдФрд░ рдЙрд╕рдХреЗ рдкреНрд░рд╛рд░реВрдк рдХреЛ рд╕рдВрджрд░реНрднрд┐рдд рдХрд░рдирд╛ рдЪреБрдирддреЗ рд╣реИрдВред

=== "рдкрд╣рд▓реЗ"

    ```groovy title="modules/samtools/index/tests/main.nf.test" linenums="7"
    test("Should run without failures") {
    ```

### 1.5. рдЯреЗрд╕реНрдЯ рдЪрд▓рд╛рдПрдВ рдФрд░ рдЖрдЙрдЯрдкреБрдЯ рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ

рдЯреЗрд╕реНрдЯ рдЪрд▓рд╛рдПрдВ:

```bash
nf-test test modules/samtools/index/tests/main.nf.test
```

??? success "рдХрдорд╛рдВрдб рдЖрдЙрдЯрдкреБрдЯ"

    ```console
    ЁЯЪА nf-test 0.9.3
    https://www.nf-test.com
    (c) 2021 - 2024 Lukas Forer and Sebastian Schoenherr


    Test Process SAMTOOLS_INDEX

      Test [625e39ee] 'Should index reads_son.bam correctly' PASSED (7.717s)
      Snapshots:
        1 created [Should index reads_son.bam correctly]


    Snapshot Summary:
      1 created

    SUCCESS: Executed 1 tests in 7.727s
    ```

рдЬреИрд╕рд╛ рдХрд┐ рд╣рдордиреЗ рдкрд╣рд▓реЗ рд╕реАрдЦрд╛, рдЗрд╕рдиреЗ process рдХреА рд╕рдлрд▓рддрд╛ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдореВрд▓ assertion рдХреЛ рд╕рддреНрдпрд╛рдкрд┐рдд рдХрд┐рдпрд╛ рдФрд░ process рдХреЗ рдЖрдЙрдЯрдкреБрдЯ рдХреЗ рдЖрдзрд╛рд░ рдкрд░ рдПрдХ snapshot рдлрд╝рд╛рдЗрд▓ рдмрдирд╛рдИред рд╣рдо `tests/modules/samtools/index/tests/main.nf.test.snap` рдлрд╝рд╛рдЗрд▓ рдореЗрдВ snapshot рдлрд╝рд╛рдЗрд▓ рдХреА рд╕рд╛рдордЧреНрд░реА рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ:

```json title="modules/samtools/index/tests/main.nf.test.snap" linenums="1"
{
  "Should index reads_son.bam correctly": {
    "content": [
      {
        "0": [
          [
            "reads_son.bam:md5,af5956d9388ba017944bef276b71d809",
            "reads_son.bam.bai:md5,a2ca7b84998218ee77eff14af8eb8ca2"
          ]
        ]
      }
    ],
    "meta": {
      "nf-test": "0.9.3",
      "nextflow": "25.10.2"
    },
    "timestamp": "2026-01-27T15:09:48.394063389"
  }
}
```

рд╣рдо рдЯреЗрд╕реНрдЯ рдХреЛ рдлрд┐рд░ рд╕реЗ рдЪрд▓рд╛ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рдпрд╣ рдкрд╛рд╕ рд╣реЛ рдЬрд╛рддрд╛ рд╣реИ, рдХреНрдпреЛрдВрдХрд┐ рдЖрдЙрдЯрдкреБрдЯ snapshot рдХреЗ рд╕рдорд╛рди рд╣реИ:

```bash
nf-test test modules/samtools/index/tests/main.nf.test
```

??? success "рдХрдорд╛рдВрдб рдЖрдЙрдЯрдкреБрдЯ"

    ```console
    ЁЯЪА nf-test 0.9.3
    https://www.nf-test.com
    (c) 2021 - 2024 Lukas Forer and Sebastian Schoenherr


    Test Process SAMTOOLS_INDEX

      Test [625e39ee] 'Should index reads_son.bam correctly' PASSED (7.938s)


    SUCCESS: Executed 1 tests in 7.987s
    ```

### 1.6. `SAMTOOLS_INDEX` рдореЗрдВ рдЕрдзрд┐рдХ рдЯреЗрд╕реНрдЯ рдЬреЛрдбрд╝реЗрдВ

рдХрднреА-рдХрднреА рдпрд╣ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐ рд╣рдо рд╡рд┐рднрд┐рдиреНрди рд╕рдВрднрд╛рд╡рд┐рдд рдореБрджреНрджреЛрдВ рдХреЗ рд▓рд┐рдП рдЯреЗрд╕реНрдЯ рдХрд░ рд░рд╣реЗ рд╣реИрдВ, рд╡рд┐рднрд┐рдиреНрди рдЗрдирдкреБрдЯ рдлрд╝рд╛рдЗрд▓реЛрдВ рдХреА рдПрдХ рд╢реНрд░реГрдВрдЦрд▓рд╛ рдХреЛ рдЯреЗрд╕реНрдЯ рдХрд░рдирд╛ рдЙрдкрдпреЛрдЧреА рд╣реЛрддрд╛ рд╣реИред рд╣рдорд╛рд░реЗ рдЯреЗрд╕реНрдЯ рдбреЗрдЯрд╛ рд╕реЗ trio рдореЗрдВ mother рдФрд░ father рдХреА BAM рдлрд╝рд╛рдЗрд▓реЛрдВ рдХреЗ рд▓рд┐рдП рдЯреЗрд╕реНрдЯ рдЬреЛрдбрд╝реЗрдВред

```groovy
    test("Should index reads_mother.bam correctly") {

        when {
            params {
                // define parameters here
            }
            process {
                """
                input[0] = file("${projectDir}/data/bam/reads_mother.bam")
                """
            }
        }

        then {
            assert process.success
            assert snapshot(process.out).match()
        }

    }

    test("Should index reads_father.bam correctly") {

        when {
            params {
                // define parameters here
            }
            process {
                """
                input[0] = file("${projectDir}/data/bam/reads_father.bam")
                """
            }
        }

        then {
            assert process.success
            assert snapshot(process.out).match()
        }

    }
```

рдлрд┐рд░ рдЖрдк рдЯреЗрд╕реНрдЯ рдХреЛ рдлрд┐рд░ рд╕реЗ рдЪрд▓рд╛ рд╕рдХрддреЗ рд╣реИрдВ:

```bash
nf-test test modules/samtools/index/tests/main.nf.test
```

??? success "рдХрдорд╛рдВрдб рдЖрдЙрдЯрдкреБрдЯ"

    ```console
    ЁЯЪА nf-test 0.9.3
    https://www.nf-test.com
    (c) 2021 - 2024 Lukas Forer and Sebastian Schoenherr


    Test Process SAMTOOLS_INDEX

      Test [625e39ee] 'Should index reads_son.bam correctly' PASSED (7.185s)
      Test [a8b28f36] 'Should index reads_mother.bam correctly' PASSED (6.576s)
      Test [c15852a1] 'Should index reads_father.bam correctly' PASSED (6.31s)
      Snapshots:
        2 created [Should index reads_father.bam correctly, Should index reads_mother.bam correctly]


    Snapshot Summary:
      2 created

    SUCCESS: Executed 3 tests in 20.117s
    ```

рдЪреЗрддрд╛рд╡рдиреА рдкрд░ рдзреНрдпрд╛рди рджреЗрдВ, рдЬреЛ `--update-snapshot` рдкреИрд░рд╛рдореАрдЯрд░ рдХреЗ рдкреНрд░рднрд╛рд╡ рдХреЛ рд╕рдВрджрд░реНрднрд┐рдд рдХрд░рддреА рд╣реИред

!!! note

    рдпрд╣рд╛рдВ рд╣рдо рдЯреЗрд╕реНрдЯ рдбреЗрдЯрд╛ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд░рд╣реЗ рд╣реИрдВ рдЬрд┐рд╕реЗ рд╣рдордиреЗ рдкрд╣рд▓реЗ pipeline рдХреЗ рд╡реИрдЬреНрдЮрд╛рдирд┐рдХ рдЖрдЙрдЯрдкреБрдЯ рдХрд╛ рдкреНрд░рджрд░реНрд╢рди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдерд╛ред
    рдпрджрд┐ рд╣рдо рдЗрди рдЯреЗрд╕реНрдЯреЛрдВ рдХреЛ production рд╡рд╛рддрд╛рд╡рд░рдг рдореЗрдВ рд╕рдВрдЪрд╛рд▓рд┐рдд рдХрд░рдиреЗ рдХреА рдпреЛрдЬрдирд╛ рдмрдирд╛ рд░рд╣реЗ рд╣реЛрддреЗ, рддреЛ рд╣рдордиреЗ testing рдЙрджреНрджреЗрд╢реНрдпреЛрдВ рдХреЗ рд▓рд┐рдП рдЫреЛрдЯреЗ рдЗрдирдкреБрдЯ рдЙрддреНрдкрдиреНрди рдХрд┐рдП рд╣реЛрддреЗред

    рд╕рд╛рдорд╛рдиреНрдп рддреМрд░ рдкрд░, process functionality рдХрд╛ рдореВрд▓реНрдпрд╛рдВрдХрди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХ рдФрд░ рдкрд░реНрдпрд╛рдкреНрдд рдбреЗрдЯрд╛ рдХреЗ рд╕рдмрд╕реЗ рдЫреЛрдЯреЗ рдЯреБрдХрдбрд╝реЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ unit tests рдХреЛ рдпрдерд╛рд╕рдВрднрд╡ рд╣рд▓реНрдХрд╛ рд░рдЦрдирд╛ рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╣реИ, рдЕрдиреНрдпрдерд╛ рдХреБрд▓ runtime рдЧрдВрднреАрд░рддрд╛ рд╕реЗ рдЬреЛрдбрд╝ рд╕рдХрддрд╛ рд╣реИред
    рдПрдХ рдЯреЗрд╕реНрдЯ suite рдЬреЛ рдирд┐рдпрдорд┐рдд рд░реВрдк рд╕реЗ рдЪрд▓рдиреЗ рдореЗрдВ рдмрд╣реБрдд рд▓рдВрдмрд╛ рд╕рдордп рд▓реЗрддрд╛ рд╣реИ, рдПрдХ рдРрд╕рд╛ рдЯреЗрд╕реНрдЯ suite рд╣реИ рдЬрд┐рд╕реЗ рд╕реБрд╡рд┐рдзрд╛ рдХреЗ рд╣рд┐рдд рдореЗрдВ рдЫреЛрдбрд╝реЗ рдЬрд╛рдиреЗ рдХреА рд╕рдВрднрд╛рд╡рдирд╛ рд╣реИред

### рдирд┐рд╖реНрдХрд░реНрд╖

рдЖрдкрдиреЗ рдПрдХ genomics process рдХреЗ рд▓рд┐рдП рдЕрдкрдирд╛ рдкрд╣рд▓рд╛ рдореЙрдбреНрдпреВрд▓ рдЯреЗрд╕реНрдЯ рд▓рд┐рдЦрд╛ рд╣реИ, рдпрд╣ рд╕рддреНрдпрд╛рдкрд┐рдд рдХрд░рддреЗ рд╣реБрдП рдХрд┐ `SAMTOOLS_INDEX` рд╡рд┐рднрд┐рдиреНрди BAM рдлрд╝рд╛рдЗрд▓реЛрдВ рдХреЗ рд▓рд┐рдП рд╕рд╣реА рддрд░реАрдХреЗ рд╕реЗ рдЗрдВрдбреЗрдХреНрд╕ рдлрд╝рд╛рдЗрд▓реЗрдВ рдмрдирд╛рддрд╛ рд╣реИред рдЯреЗрд╕реНрдЯ suite рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рддрд╛ рд╣реИ рдХрд┐:

1. Process рд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ рдЪрд▓рддрд╛ рд╣реИ
2. рдЗрдВрдбреЗрдХреНрд╕ рдлрд╝рд╛рдЗрд▓реЗрдВ рдмрдирд╛рдИ рдЧрдИ рд╣реИрдВ
3. рдЖрдЙрдЯрдкреБрдЯ runs рдореЗрдВ consistent рд╣реИрдВ
4. Process рд╕рднреА рдирдореВрдирд╛ BAM рдлрд╝рд╛рдЗрд▓реЛрдВ рдХреЗ рд▓рд┐рдП рдХрд╛рдо рдХрд░рддрд╛ рд╣реИ

### рдЖрдЧреЗ рдХреНрдпрд╛ рд╣реИ?

рд╣рдорд╛рд░реА genomics workflow рдореЗрдВ рдЕрдиреНрдп processes рдХреЗ рд▓рд┐рдП рдЯреЗрд╕реНрдЯ рд▓рд┐рдЦрдирд╛ рд╕реАрдЦреЗрдВ, chained processes рдХреЛ рд╕рдВрднрд╛рд▓рдиреЗ рдХреЗ рд▓рд┐рдП setup method рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реБрдПред рд╣рдо рдпрд╣ рднреА рдореВрд▓реНрдпрд╛рдВрдХрди рдХрд░реЗрдВрдЧреЗ рдХрд┐ рдЖрдЙрдЯрдкреБрдЯ, рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ рд╣рдорд╛рд░реА VCF рдлрд╝рд╛рдЗрд▓реЗрдВ, рдЕрдкреЗрдХреНрд╖рд┐рдд variant calls рд╢рд╛рдорд┐рд▓ рд╣реИрдВ рдпрд╛ рдирд╣реАрдВред

---

## 2. рдПрдХ chained process рдореЗрдВ рдЯреЗрд╕реНрдЯ рдЬреЛрдбрд╝реЗрдВ рдФрд░ рд╕рд╛рдордЧреНрд░реА рдХреЗ рд▓рд┐рдП рдЯреЗрд╕реНрдЯ рдХрд░реЗрдВ

`GATK_HAPLOTYPECALLER` рдХреЛ рдЯреЗрд╕реНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рд╣рдореЗрдВ process рдХреЛ рдЗрдирдкреБрдЯ рдХреЗ рд░реВрдк рдореЗрдВ `SAMTOOLS_INDEX` рдЖрдЙрдЯрдкреБрдЯ рдкреНрд░рджрд╛рди рдХрд░рдирд╛ рд╣реЛрдЧрд╛ред рд╣рдо `SAMTOOLS_INDEX` рдХреЛ рдЪрд▓рд╛рдХрд░, рдЗрд╕рдХреЗ рдЖрдЙрдЯрдкреБрдЯ рдХреЛ рдкреБрдирд░реНрдкреНрд░рд╛рдкреНрдд рдХрд░рдХреЗ, рдФрд░ рдЙрдиреНрд╣реЗрдВ workflow рдХреЗ рд▓рд┐рдП рдЯреЗрд╕реНрдЯ рдбреЗрдЯрд╛ рдХреЗ рд╕рд╛рде рд╕рдВрдЧреНрд░рд╣реАрдд рдХрд░рдХреЗ рдРрд╕рд╛ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ рдпрд╣ рдПрдХ polished pipeline рдХреЗ рд▓рд┐рдП рдЕрдиреБрд╢рдВрд╕рд┐рдд рджреГрд╖реНрдЯрд┐рдХреЛрдг рд╣реИ, рд▓реЗрдХрд┐рди nf-test `setup` method рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдПрдХ рд╡реИрдХрд▓реНрдкрд┐рдХ рджреГрд╖реНрдЯрд┐рдХреЛрдг рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИред

setup method рдХреЗ рд╕рд╛рде, рд╣рдо рдЯреЗрд╕реНрдЯ setup рдХреЗ рд╣рд┐рд╕реНрд╕реЗ рдХреЗ рд░реВрдк рдореЗрдВ `SAMTOOLS_INDEX` process рдХреЛ рдЯреНрд░рд┐рдЧрд░ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рдФрд░ рдлрд┐рд░ рдЗрд╕рдХреЗ рдЖрдЙрдЯрдкреБрдЯ рдХреЛ `GATK_HAPLOTYPECALLER` рдХреЗ рд▓рд┐рдП рдЗрдирдкреБрдЯ рдХреЗ рд░реВрдк рдореЗрдВ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдЗрд╕рдХреА рдПрдХ рд▓рд╛рдЧрдд рд╣реИ: рд╣рдореЗрдВ рд╣рд░ рдмрд╛рд░ `GATK_HAPLOTYPECALLER` рдХреЗ рд▓рд┐рдП рдЯреЗрд╕реНрдЯ рдЪрд▓рд╛рддреЗ рд╕рдордп `SAMTOOLS_INDEX` process рдЪрд▓рд╛рдиреА рд╣реЛрдЧреАред рд╣рд╛рд▓рд╛рдВрдХрд┐, рд╢рд╛рдпрдж рд╣рдо рдЕрднреА рднреА workflow рд╡рд┐рдХрд╕рд┐рдд рдХрд░ рд░рд╣реЗ рд╣реИрдВ рдФрд░ рдЯреЗрд╕реНрдЯ рдбреЗрдЯрд╛ pre-generate рдирд╣реАрдВ рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рдЬрд┐рд╕реЗ рд╣рдореЗрдВ рдмрд╛рдж рдореЗрдВ рдмрджрд▓рдирд╛ рдкрдбрд╝ рд╕рдХрддрд╛ рд╣реИред `SAMTOOLS_INDEX` process рднреА рдмрд╣реБрдд рддреЗрдЬрд╝ рд╣реИ, рдЗрд╕рд▓рд┐рдП рд╢рд╛рдпрдж рдЗрд╕рдХреЗ рдЖрдЙрдЯрдкреБрдЯ рдХреЛ pre-generate рдФрд░ рд╕реНрдЯреЛрд░ рдХрд░рдиреЗ рдХреЗ рд▓рд╛рдн рдирдЧрдгреНрдп рд╣реИрдВред рдпрд╣рд╛рдВ рдмрддрд╛рдпрд╛ рдЧрдпрд╛ рд╣реИ рдХрд┐ setup method рдХреИрд╕реЗ рдХрд╛рдо рдХрд░рддрд╛ рд╣реИред

### 2.1. рдЯреЗрд╕реНрдЯ рдлрд╝рд╛рдЗрд▓ рдЙрддреНрдкрдиреНрди рдХрд░реЗрдВ рдФрд░ рд░рдЦреЗрдВ

рдкрд╣рд▓реЗ рдХреА рддрд░рд╣, рд╕рдмрд╕реЗ рдкрд╣рд▓реЗ рд╣рдо рдлрд╝рд╛рдЗрд▓ stub рдЙрддреНрдкрдиреНрди рдХрд░рддреЗ рд╣реИрдВ:

```bash
nf-test generate process modules/gatk/haplotypecaller/main.nf
```

??? success "рдХрдорд╛рдВрдб рдЖрдЙрдЯрдкреБрдЯ"

    ```console
    Load source file '/workspaces/training/nf4-science/genomics/modules/gatk/haplotypecaller/main.nf'
    Wrote process test file '/workspaces/training/nf4-science/genomics/tests/modules/gatk/haplotypecaller/main.nf.test'

    SUCCESS: Generated 1 test files.
    ```

рдпрд╣ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдЯреЗрд╕реНрдЯ stub рдЙрддреНрдкрдиреНрди рдХрд░рддрд╛ рд╣реИ:

```groovy title="tests/modules/gatk/haplotypecaller/main.nf.test" linenums="1"
nextflow_process {

    name "Test Process GATK_HAPLOTYPECALLER"
    script "modules/gatk/haplotypecaller/main.nf"
    process "GATK_HAPLOTYPECALLER"

    test("Should run without failures") {

        when {
            params {
                // define parameters here. Example:
                // outdir = "tests/results"
            }
            process {
                """
                // define inputs of the process here. Example:
                // input[0] = file("test-file.txt")
                """
            }
        }

        then {
            assert process.success
            assert snapshot(process.out).match()
        }

    }

}
```

### 2.2. рдЯреЗрд╕реНрдЯ рдлрд╝рд╛рдЗрд▓ рдХреЛ рд╕реНрдерд╛рдирд╛рдВрддрд░рд┐рдд рдХрд░реЗрдВ рдФрд░ script path рдХреЛ рдЕрдкрдбреЗрдЯ рдХрд░реЗрдВ

рд╣рдо рдореЙрдбреНрдпреВрд▓ рдХреА `main.nf` рдлрд╝рд╛рдЗрд▓ рдХреЗ рд╕рд╛рде co-located рдЯреЗрд╕реНрдЯ рдлрд╝рд╛рдЗрд▓ рдХреЗ рд▓рд┐рдП рдПрдХ рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рдмрдирд╛рддреЗ рд╣реИрдВ:

```bash
mkdir -p modules/gatk/haplotypecaller/tests
```

рдФрд░ рдЯреЗрд╕реНрдЯ stub рдлрд╝рд╛рдЗрд▓ рдХреЛ рд╡рд╣рд╛рдБ рд╕реНрдерд╛рдирд╛рдВрддрд░рд┐рдд рдХрд░реЗрдВ:

```bash
mv tests/modules/gatk/haplotypecaller/main.nf.test modules/gatk/haplotypecaller/tests/
```

рдЕрдВрдд рдореЗрдВ, script path рдХреЛ рдЕрдкрдбреЗрдЯ рдХрд░рдирд╛ рди рднреВрд▓реЗрдВ:

=== "рдмрд╛рдж рдореЗрдВ"

    ```groovy title="modules/gatk/haplotypecaller/tests/main.nf.test" linenums="3" hl_lines="2"
        name "Test Process GATK_HAPLOTYPECALLER"
        script "../main.nf"
        process "GATK_HAPLOTYPECALLER"
    ```

=== "рдкрд╣рд▓реЗ"

    ```groovy title="modules/gatk/haplotypecaller/tests/main.nf.test" linenums="3" hl_lines="2"
        name "Test Process GATK_HAPLOTYPECALLER"
        script "modules/gatk/haplotypecaller/main.nf"
        process "GATK_HAPLOTYPECALLER"
    ```

### 2.3. setup method рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЗрдирдкреБрдЯ рдкреНрд░рджрд╛рди рдХрд░реЗрдВ

рд╣рдо `when` block рд╕реЗ рдкрд╣рд▓реЗ рдПрдХ `setup` block рдбрд╛рд▓рддреЗ рд╣реИрдВ, рдЬрд╣рд╛рдВ рд╣рдо рд╣рдорд╛рд░реА рдореВрд▓ рдЗрдирдкреБрдЯ рдлрд╝рд╛рдЗрд▓реЛрдВ рдореЗрдВ рд╕реЗ рдПрдХ рдкрд░ `SAMTOOLS_INDEX` process рдХрд╛ рдПрдХ рд░рди рдЯреНрд░рд┐рдЧрд░ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рд╕рд╛рде рд╣реА, рдкрд╣рд▓реЗ рдХреА рддрд░рд╣ рдЯреЗрд╕реНрдЯ рдХреЗ рдирд╛рдо рдХреЛ рдХреБрдЫ рд╕рд╛рд░реНрдердХ рдореЗрдВ рдмрджрд▓рдирд╛ рдпрд╛рдж рд░рдЦреЗрдВред

=== "рдмрд╛рдж рдореЗрдВ"

    ```groovy title="modules/gatk/haplotypecaller/tests/main.nf.test" linenums="7" hl_lines="1-12"
        test("Should call son's haplotype correctly") {

            setup {
                run("SAMTOOLS_INDEX") {
                    script "../../../samtools/index/main.nf"
                    process {
                        """
                        input[0] =  file("${projectDir}/data/bam/reads_son.bam")
                        """
                    }
                }
            }

            when {
    ```

=== "рдкрд╣рд▓реЗ"

    ```groovy title="modules/gatk/haplotypecaller/tests/main.nf.test" linenums="7"  hl_lines="1"
    test("Should run without failures") {

        when {
    ```

рдлрд┐рд░ рд╣рдо рдЙрд╕ process рдХреЗ рдЖрдЙрдЯрдкреБрдЯ рдХреЛ `when` block рдореЗрдВ рд╕рдВрджрд░реНрднрд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдЬрд╣рд╛рдВ рд╣рдо рдЯреЗрд╕реНрдЯ рдЗрдирдкреБрдЯ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░рддреЗ рд╣реИрдВ:

```groovy title="modules/gatk/haplotypecaller/tests/main.nf.test" linenums="20"
        when {
            params {
                // define parameters here
            }
            process {
                """
                input[0] = SAMTOOLS_INDEX.out
                input[1] = file("${projectDir}/data/ref/ref.fasta")
                input[2] = file("${projectDir}/data/ref/ref.fasta.fai")
                input[3] = file("${projectDir}/data/ref/ref.dict")
                input[4] = file("${projectDir}/data/ref/intervals.bed")
                """
            }
        }
```

рд╡рд╣ рдкрд░рд┐рд╡рд░реНрддрди рдХрд░реЗрдВ рдФрд░ рдЯреЗрд╕реНрдЯ рдХреЛ рдлрд┐рд░ рд╕реЗ рдЪрд▓рд╛рдПрдВ:

```bash
nf-test test modules/gatk/haplotypecaller/tests/main.nf.test
```

??? success "рдХрдорд╛рдВрдб рдЖрдЙрдЯрдкреБрдЯ"

    ```console
    ЁЯЪА nf-test 0.9.3
    https://www.nf-test.com
    (c) 2021 - 2024 Lukas Forer and Sebastian Schoenherr


    Test Process GATK_HAPLOTYPECALLER

      Test [c5156c2b] 'Should call son's haplotype correctly' PASSED (40.53s)
      Snapshots:
        1 created [Should call son's haplotype correctly]


    Snapshot Summary:
      1 created

    SUCCESS: Executed 1 tests in 40.555s
    ```

рдпрд╣ рдкрд╣рд▓реЗ рдХреА рддрд░рд╣ рдПрдХ snapshot рдлрд╝рд╛рдЗрд▓ рднреА рдЙрддреНрдкрдиреНрди рдХрд░рддрд╛ рд╣реИред

### 2.4. рдлрд┐рд░ рд╕реЗ рдЪрд▓рд╛рдПрдВ рдФрд░ рд╡рд┐рдлрд▓рддрд╛ рджреЗрдЦреЗрдВ

рджрд┐рд▓рдЪрд╕реНрдк рдмрд╛рдд рдпрд╣ рд╣реИ рдХрд┐ рдпрджрд┐ рдЖрдк рдмрд┐рд▓реНрдХреБрд▓ рд╡рд╣реА рдХрдорд╛рдВрдб рдлрд┐рд░ рд╕реЗ рдЪрд▓рд╛рддреЗ рд╣реИрдВ, рддреЛ рдЗрд╕ рдмрд╛рд░ рдЯреЗрд╕реНрдЯ рд╡рд┐рдлрд▓ рд╣реЛ рдЬрд╛рдПрдЧрд╛ред

```bash
nf-test test modules/gatk/haplotypecaller/tests/main.nf.test
```

??? failure "рдХрдорд╛рдВрдб рдЖрдЙрдЯрдкреБрдЯ"

    ```console
    ЁЯЪА nf-test 0.9.3
    https://www.nf-test.com
    (c) 2021 - 2024 Lukas Forer and Sebastian Schoenherr


    Test Process GATK_HAPLOTYPECALLER

      Test [c5156c2b] 'Should call son's haplotype correctly' FAILED (40.123s)

      java.lang.RuntimeException: Different Snapshot:
      [                                                                                           [
          {                                                                                           {
              "0": [                                                                                      "0": [
                  "reads_son.bam.g.vcf:md5,069316cdd4328542ffc6ae247b1dac39"                         |                 "reads_son.bam.g.vcf:md5,005f1a13ee39f11b0fc9bea094850eac"
              ],                                                                                          ],
              "1": [                                                                                      "1": [
                  "reads_son.bam.g.vcf.idx:md5,dc36c18f2afdc546f41e68b2687e9334"                     |                 "reads_son.bam.g.vcf.idx:md5,dbad4b76a4b90c158ffc9c9740764242"
              ],                                                                                          ],
              "idx": [                                                                                    "idx": [
                  "reads_son.bam.g.vcf.idx:md5,dc36c18f2afdc546f41e68b2687e9334"                     |                 "reads_son.bam.g.vcf.idx:md5,dbad4b76a4b90c158ffc9c9740764242"
              ],                                                                                          ],
              "vcf": [                                                                                    "vcf": [
                  "reads_son.bam.g.vcf:md5,069316cdd4328542ffc6ae247b1dac39"                         |                 "reads_son.bam.g.vcf:md5,005f1a13ee39f11b0fc9bea094850eac"
              ]                                                                                           ]
          }                                                                                           }
      ]                                                                                           ]

      Nextflow stdout:

      Nextflow stderr:


        Obsolete snapshots can only be checked if all tests of a file are executed successful.


    FAILURE: Executed 1 tests in 40.156s (1 failed)
    ```

рддреНрд░реБрдЯрд┐ рд╕рдВрджреЗрд╢ рдЖрдкрдХреЛ рдмрддрд╛рддрд╛ рд╣реИ рдХрд┐ рджреЛ runs рдХреЗ рд▓рд┐рдП snapshots рдХреЗ рдмреАрдЪ рдЕрдВрддрд░ рдереЗ; рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ, VCF рдлрд╝рд╛рдЗрд▓реЛрдВ рдХреЗ рд▓рд┐рдП md5sum values рдЕрд▓рдЧ рд╣реИрдВред

рдХреНрдпреЛрдВ? рдПрдХ рд▓рдВрдмреА рдХрд╣рд╛рдиреА рдХреЛ рдЫреЛрдЯрд╛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, HaplotypeCaller tool рдореЗрдВ VCF header рдореЗрдВ рдПрдХ timestamp рд╢рд╛рдорд┐рд▓ рд╣реИ рдЬреЛ рд╣рд░ рдмрд╛рд░ рдЕрд▓рдЧ рд╣реИ (рдкрд░рд┐рднрд╛рд╖рд╛ рдХреЗ рдЕрдиреБрд╕рд╛рд░)ред
рдкрд░рд┐рдгрд╛рдорд╕реНрд╡рд░реВрдк, рд╣рдо рдХреЗрд╡рд▓ рдпрд╣ рдЙрдореНрдореАрдж рдирд╣реАрдВ рдХрд░ рд╕рдХрддреЗ рдХрд┐ рдлрд╝рд╛рдЗрд▓реЛрдВ рдореЗрдВ рд╕рдорд╛рди md5sums рд╣реЛрдВрдЧреЗ рднрд▓реЗ рд╣реА рдЙрдирдореЗрдВ variant calls рдХреЗ рд╕рдВрджрд░реНрдн рдореЗрдВ рд╕рдорд╛рди рд╕рд╛рдордЧреНрд░реА рд╣реЛред

рд╣рдо рдЗрд╕рд╕реЗ рдХреИрд╕реЗ рдирд┐рдкрдЯрддреЗ рд╣реИрдВ?

### 2.5. рдПрдХ рд╡рд┐рд╢рд┐рд╖реНрдЯ variant рдХреА рдЬрд╛рдВрдЪ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП content assertion method рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ

рд╕рдорд╕реНрдпрд╛ рдХреЛ рд╣рд▓ рдХрд░рдиреЗ рдХрд╛ рдПрдХ рддрд░реАрдХрд╛ [рдПрдХ рдЕрд▓рдЧ рдкреНрд░рдХрд╛рд░ рдХреЗ assertion](https://nf-co.re/docs/contributing/tutorials/nf-test_assertions) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рд╣реИред
рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ, рд╣рдо identity рдХреЛ assert рдХрд░рдиреЗ рдХреЗ рдмрдЬрд╛рдп рд╡рд┐рд╢рд┐рд╖реНрдЯ рд╕рд╛рдордЧреНрд░реА рдХреА рдЬрд╛рдВрдЪ рдХрд░рдиреЗ рдЬрд╛ рд░рд╣реЗ рд╣реИрдВред
рдЕрдзрд┐рдХ рд╕рдЯреАрдХ рд░реВрдк рд╕реЗ, рд╣рдо tool рдХреЛ VCF рдлрд╝рд╛рдЗрд▓ рдХреА lines рдкрдврд╝рдиреЗ рдФрд░ рд╡рд┐рд╢рд┐рд╖реНрдЯ lines рдХреЗ рдЕрд╕реНрддрд┐рддреНрд╡ рдХреА рдЬрд╛рдВрдЪ рдХрд░рдиреЗ рджреЗрдВрдЧреЗред

рд╡реНрдпрд╡рд╣рд╛рд░ рдореЗрдВ, рд╣рдо `then` block рдореЗрдВ рджреВрд╕рд░реЗ assertion рдХреЛ рдирд┐рдореНрдирд╛рдиреБрд╕рд╛рд░ рдмрджрд▓ рджреЗрддреЗ рд╣реИрдВ:

=== "рдмрд╛рдж рдореЗрдВ"

    ```groovy title="modules/gatk/haplotypecaller/tests/main.nf.test" linenums="35" hl_lines="3 4"
            then {
                assert process.success
                assert path(process.out[0][0]).readLines().contains('#CHROM	POS	ID	REF	ALT	QUAL	FILTER	INFO	FORMAT	reads_son')
                assert path(process.out[0][0]).readLines().contains('20_10037292_10066351	3277	.	G	<NON_REF>	.	.	END=3282	GT:DP:GQ:MIN_DP:PL	0/0:25:72:24:0,72,719')
            }
    ```

=== "рдкрд╣рд▓реЗ"

    ```groovy title="modules/gatk/haplotypecaller/tests/main.nf.test" linenums="35" hl_lines="3"
    then {
        assert process.success
        assert snapshot(process.out).match()
    }
    ```

рдпрд╣рд╛рдВ рд╣рдо VCF рдЖрдЙрдЯрдкреБрдЯ рдлрд╝рд╛рдЗрд▓ рдХреА рдкреВрд░реА рд╕рд╛рдордЧреНрд░реА рдХреЛ рдкрдврд╝ рд░рд╣реЗ рд╣реИрдВ рдФрд░ content match рдХреА рдЦреЛрдЬ рдХрд░ рд░рд╣реЗ рд╣реИрдВ, рдЬреЛ рдПрдХ рдЫреЛрдЯреА рдЯреЗрд╕реНрдЯ рдлрд╝рд╛рдЗрд▓ рдкрд░ рдХрд░рдирд╛ рдареАрдХ рд╣реИ, рд▓реЗрдХрд┐рди рдЖрдк рдХрд┐рд╕реА рдмрдбрд╝реА рдлрд╝рд╛рдЗрд▓ рдкрд░ рдРрд╕рд╛ рдирд╣реАрдВ рдХрд░рдирд╛ рдЪрд╛рд╣реЗрдВрдЧреЗред
рдЖрдк рдЗрд╕рдХреЗ рдмрдЬрд╛рдп рд╡рд┐рд╢рд┐рд╖реНрдЯ lines рдкрдврд╝рдирд╛ рдЪреБрди рд╕рдХрддреЗ рд╣реИрдВред

рдЗрд╕ рджреГрд╖реНрдЯрд┐рдХреЛрдг рдХреЗ рд▓рд┐рдП рдЕрдзрд┐рдХ рд╕рд╛рд╡рдзрд╛рдиреА рд╕реЗ рдЪреБрдирдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ рдХрд┐ рд╣рдо 'signal' рдХреЗ рд░реВрдк рдореЗрдВ рдХрд┐рд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВред
рд╕рдХрд╛рд░рд╛рддреНрдордХ рдкрдХреНрд╖ рдореЗрдВ, рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдмрдбрд╝реА рд╕рдЯреАрдХрддрд╛ рдХреЗ рд╕рд╛рде рдпрд╣ рдЯреЗрд╕реНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рдХрд┐ рдХреНрдпрд╛ рдПрдХ analysis tool рд▓рдЧрд╛рддрд╛рд░ 'рдХрдард┐рди' рд╕реБрд╡рд┐рдзрд╛рдУрдВ (рдЬреИрд╕реЗ rare variants) рдХреА рдкрд╣рдЪрд╛рди рдХрд░ рд╕рдХрддрд╛ рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рдпрд╣ рдЖрдЧреЗ рдХреЗ рд╡рд┐рдХрд╛рд╕ рд╕реЗ рдЧреБрдЬрд░рддрд╛ рд╣реИред

### 2.6. рдлрд┐рд░ рд╕реЗ рдЪрд▓рд╛рдПрдВ рдФрд░ рд╕рдлрд▓рддрд╛ рджреЗрдЦреЗрдВ

рдПрдХ рдмрд╛рд░ рдЬрдм рд╣рдордиреЗ рдЗрд╕ рддрд░рд╣ рд╕реЗ рдЯреЗрд╕реНрдЯ рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░ рд▓рд┐рдпрд╛ рд╣реИ, рддреЛ рд╣рдо рдЯреЗрд╕реНрдЯ рдХреЛ рдХрдИ рдмрд╛рд░ рдЪрд▓рд╛ рд╕рдХрддреЗ рд╣реИрдВ, рдФрд░ рдпрд╣ рд▓рдЧрд╛рддрд╛рд░ рдкрд╛рд╕ рд╣реЛрдЧрд╛ред

```bash
nf-test test modules/gatk/haplotypecaller/tests/main.nf.test
```

??? success "рдХрдорд╛рдВрдб рдЖрдЙрдЯрдкреБрдЯ"

    ```console
    ЁЯЪА nf-test 0.9.3
    https://www.nf-test.com
    (c) 2021 - 2024 Lukas Forer and Sebastian Schoenherr


    Test Process GATK_HAPLOTYPECALLER

      Test [c5156c2b] 'Should call son's haplotype correctly' PASSED (40.53s)


    SUCCESS: Executed 1 tests in 40.555s
    ```

### 2.7. рдЕрдзрд┐рдХ рдЯреЗрд╕реНрдЯ рдЬреЛрдбрд╝реЗрдВ

mother рдФрд░ father рдирдореВрдиреЛрдВ рдХреЗ рд▓рд┐рдП рд╕рдорд╛рди рдЯреЗрд╕реНрдЯ рдЬреЛрдбрд╝реЗрдВ:

```groovy title="modules/gatk/haplotypecaller/tests/main.nf.test" linenums="43"
    test("Should call mother's haplotype correctly") {

        setup {
            run("SAMTOOLS_INDEX") {
                script "../../../samtools/index/main.nf"
                process {
                    """
                    input[0] =  file("${projectDir}/data/bam/reads_mother.bam")
                    """
                }
            }
        }

        when {
            params {
                // define parameters here
            }
            process {
                """
                input[0] = SAMTOOLS_INDEX.out
                input[1] = file("${projectDir}/data/ref/ref.fasta")
                input[2] = file("${projectDir}/data/ref/ref.fasta.fai")
                input[3] = file("${projectDir}/data/ref/ref.dict")
                input[4] = file("${projectDir}/data/ref/intervals.bed")
                """
            }
        }

        then {
            assert process.success
            assert path(process.out[0][0]).readLines().contains('#CHROM	POS	ID	REF	ALT	QUAL	FILTER	INFO	FORMAT	reads_mother')
            assert path(process.out[0][0]).readLines().contains('20_10037292_10066351	3277	.	G	<NON_REF>	.	.	END=3278	GT:DP:GQ:MIN_DP:PL	0/0:38:99:37:0,102,1530')
        }
    }

    test("Should call father's haplotype correctly") {

        setup {
            run("SAMTOOLS_INDEX") {
                script "../../../samtools/index/main.nf"
                process {
                    """
                    input[0] =  file("${projectDir}/data/bam/reads_father.bam")
                    """
                }
            }
        }

        when {
            params {
                // define parameters here
            }
            process {
                """
                input[0] = SAMTOOLS_INDEX.out
                input[1] = file("${projectDir}/data/ref/ref.fasta")
                input[2] = file("${projectDir}/data/ref/ref.fasta.fai")
                input[3] = file("${projectDir}/data/ref/ref.dict")
                input[4] = file("${projectDir}/data/ref/intervals.bed")
                """
            }
        }

        then {
            assert process.success
            assert path(process.out[0][0]).readLines().contains('#CHROM	POS	ID	REF	ALT	QUAL	FILTER	INFO	FORMAT	reads_father')
            assert path(process.out[0][0]).readLines().contains('20_10037292_10066351	3277	.	G	<NON_REF>	.	.	END=3281	GT:DP:GQ:MIN_DP:PL	0/0:44:99:42:0,120,1800')
        }
    }
```

### 2.8. рдЯреЗрд╕реНрдЯ рдХрдорд╛рдВрдб рдЪрд▓рд╛рдПрдВ

```bash
nf-test test modules/gatk/haplotypecaller/tests/main.nf.test
```

??? success "рдХрдорд╛рдВрдб рдЖрдЙрдЯрдкреБрдЯ"

    ```console
    ЁЯЪА nf-test 0.9.3
    https://www.nf-test.com
    (c) 2021 - 2024 Lukas Forer and Sebastian Schoenherr


    Test Process GATK_HAPLOTYPECALLER

      Test [c5156c2b] 'Should call son's haplotype correctly' PASSED (40.53s)
      Test [10de94a8] 'Should call mother's haplotype correctly' PASSED (41.47s)
      Test [c0386fc7] 'Should call father's haplotype correctly' PASSED (45.556s)


    SUCCESS: Executed 3 tests in 127.586s
    ```

рдпрд╣ pipeline рдореЗрдВ рдЗрд╕ рджреВрд╕рд░реЗ рдЪрд░рдг рдХреЗ рд▓рд┐рдП рдореВрд▓ рдЯреЗрд╕реНрдЯ рдпреЛрдЬрдирд╛ рдХреЛ рдкреВрд░рд╛ рдХрд░рддрд╛ рд╣реИред рддреАрд╕рд░реЗ рдФрд░ рдЕрдВрддрд┐рдо module-level рдЯреЗрд╕реНрдЯ рдкрд░ рдЖрдЧреЗ рдмрдврд╝реЗрдВ!

### рдирд┐рд╖реНрдХрд░реНрд╖

рдЖрдкрдиреЗ рд╕реАрдЦрд╛ рдХрд┐ рдХреИрд╕реЗ:

1. рдЙрди processes рдХреЛ рдЯреЗрд╕реНрдЯ рдХрд░реЗрдВ рдЬреЛ рдЕрдиреНрдп processes рдХреЗ рдЖрдЙрдЯрдкреБрдЯ рдкрд░ рдирд┐рд░реНрднрд░ рд╣реИрдВ
2. VCF рдЖрдЙрдЯрдкреБрдЯ рдлрд╝рд╛рдЗрд▓реЛрдВ рдореЗрдВ рд╡рд┐рд╢рд┐рд╖реНрдЯ genomic variants рд╕рддреНрдпрд╛рдкрд┐рдд рдХрд░реЗрдВ
3. рд╡рд┐рд╢рд┐рд╖реНрдЯ рд╕рд╛рдордЧреНрд░реА рдХреА рдЬрд╛рдВрдЪ рдХрд░рдХреЗ non-deterministic рдЖрдЙрдЯрдкреБрдЯ рдХреЛ рд╕рдВрднрд╛рд▓реЗрдВ
4. рдХрдИ рдирдореВрдиреЛрдВ рдореЗрдВ variant calling рдЯреЗрд╕реНрдЯ рдХрд░реЗрдВ

### рдЖрдЧреЗ рдХреНрдпрд╛ рд╣реИ?

joint genotyping рдЪрд░рдг рдХреЗ рд▓рд┐рдП pre-generated рдЯреЗрд╕реНрдЯ рдбреЗрдЯрд╛ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рдЯреЗрд╕реНрдЯ рд▓рд┐рдЦрдирд╛ рд╕реАрдЦреЗрдВред

---

## 3. Pre-generated рдЯреЗрд╕реНрдЯ рдбреЗрдЯрд╛ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ

joint genotyping рдЪрд░рдг рдХреЗ рд▓рд┐рдП, рд╣рдо рдПрдХ рдЕрд▓рдЧ рджреГрд╖реНрдЯрд┐рдХреЛрдг рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВрдЧреЗ - pre-generated рдЯреЗрд╕реНрдЯ рдбреЗрдЯрд╛ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ред рдпрд╣ рдЕрдХреНрд╕рд░ рдЗрд╕рдХреЗ рд▓рд┐рдП рдмреЗрд╣рддрд░ рд╣реЛрддрд╛ рд╣реИ:

1. рдХрдИ dependencies рдХреЗ рд╕рд╛рде рдЬрдЯрд┐рд▓ processes
2. Processes рдЬреЛ рдЪрд▓рдиреЗ рдореЗрдВ рд▓рдВрдмрд╛ рд╕рдордп рд▓реЗрддреА рд╣реИрдВ
3. Processes рдЬреЛ рдПрдХ рд╕реНрдерд┐рд░, production pipeline рдХрд╛ рд╣рд┐рд╕реНрд╕рд╛ рд╣реИрдВ

### 3.1. рдЯреЗрд╕реНрдЯ рдбреЗрдЯрд╛ рдЙрддреНрдкрдиреНрди рдХрд░реЗрдВ

рдЗрд╕ рдЦрдВрдб рдХреА рд╢реБрд░реБрдЖрдд рдореЗрдВ рд╣рдордиреЗ рдЬреЛ рдкрд░рд┐рдгрд╛рдо рдЙрддреНрдкрдиреНрди рдХрд┐рдП рдереЗ, рдЙрдирдХрд╛ рдирд┐рд░реАрдХреНрд╖рдг рдХрд░реЗрдВ:

```bash
tree results_genomics/
```

```console title="рдкрд░рд┐рдгрд╛рдо рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рдХреА рд╕рд╛рдордЧреНрд░реА"
results_genomics/
тФЬтФАтФА family_trio.joint.vcf
тФЬтФАтФА family_trio.joint.vcf.idx
тФЬтФАтФА gvcf
тФВ   тФЬтФАтФА reads_father.bam.g.vcf -> /workspaces/training/nf4-science/genomics/work/30/b2522b83c63baff8c3cf75704512a2/reads_father.bam.g.vcf
тФВ   тФЬтФАтФА reads_father.bam.g.vcf.idx -> /workspaces/training/nf4-science/genomics/work/30/b2522b83c63baff8c3cf75704512a2/reads_father.bam.g.vcf.idx
тФВ   тФЬтФАтФА reads_mother.bam.g.vcf -> /workspaces/training/nf4-science/genomics/work/f6/be2efa58e625d08cf8d0da1d0e9f09/reads_mother.bam.g.vcf
тФВ   тФЬтФАтФА reads_mother.bam.g.vcf.idx -> /workspaces/training/nf4-science/genomics/work/f6/be2efa58e625d08cf8d0da1d0e9f09/reads_mother.bam.g.vcf.idx
тФВ   тФЬтФАтФА reads_son.bam.g.vcf -> /workspaces/training/nf4-science/genomics/work/fe/2f22d56aa16ed45f8bc419312894f6/reads_son.bam.g.vcf
тФВ   тФФтФАтФА reads_son.bam.g.vcf.idx -> /workspaces/training/nf4-science/genomics/work/fe/2f22d56aa16ed45f8bc419312894f6/reads_son.bam.g.vcf.idx
тФФтФАтФА indexed_bam
    тФЬтФАтФА reads_father.bam -> /workspaces/training/nf4-science/genomics/work/42/a3bf19dbfaf1f3672b16a5d5e6a8be/reads_father.bam
    тФЬтФАтФА reads_father.bam.bai -> /workspaces/training/nf4-science/genomics/work/cf/289c2d264f496d60a69e3e9ba6463e/reads_father.bam.bai
    тФЬтФАтФА reads_mother.bam -> /workspaces/training/nf4-science/genomics/work/af/f31a6ade82cc0cf853c4f61c8bc473/reads_mother.bam
    тФЬтФАтФА reads_mother.bam.bai -> /workspaces/training/nf4-science/genomics/work/18/89dfa40a3def17e45421e54431a126/reads_mother.bam.bai
    тФЬтФАтФА reads_son.bam -> /workspaces/training/nf4-science/genomics/work/9f/9615dd553d6f13d8bec4f006ac395f/reads_son.bam
    тФФтФАтФА reads_son.bam.bai -> /workspaces/training/nf4-science/genomics/work/4d/cb384a97db5687cc9daab002017c7c/reads_son.bam.bai

2 directories, 14 files
```

joint genotyping рдЪрд░рдг рдХреЛ haplotype caller рдЪрд░рдгреЛрдВ рджреНрд╡рд╛рд░рд╛ рдЙрддреНрдкрд╛рджрд┐рдд VCF рдлрд╝рд╛рдЗрд▓реЛрдВ рдХреЛ indices рдХреЗ рд╕рд╛рде рдЗрдирдкреБрдЯ рдХреЗ рд░реВрдк рдореЗрдВ рдЪрд╛рд╣рд┐рдПред рддреЛ рдЪрд▓рд┐рдП рд╣рдорд╛рд░реЗ рдкрд╛рд╕ рдЬреЛ рдкрд░рд┐рдгрд╛рдо рд╣реИрдВ рдЙрдиреНрд╣реЗрдВ `jointgenotyping` рдореЙрдбреНрдпреВрд▓ рдХреА рдЯреЗрд╕реНрдЯ рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рдореЗрдВ рдХреЙрдкреА рдХрд░реЗрдВред

```bash
mkdir -p modules/gatk/jointgenotyping/tests/inputs/
cp results_genomics/gvcf/*.g.vcf results_genomics/gvcf/*.g.vcf.idx modules/gatk/jointgenotyping/tests/inputs/
```

рдЕрдм рд╣рдо рдЗрди рдлрд╝рд╛рдЗрд▓реЛрдВ рдХреЛ joint genotyping рдЪрд░рдг рдХреЗ рд▓рд┐рдП рд╣рдо рдЬреЛ рдЯреЗрд╕реНрдЯ рд▓рд┐рдЦрдиреЗ рдЬрд╛ рд░рд╣реЗ рд╣реИрдВ рдЙрд╕рдХреЗ рдЗрдирдкреБрдЯ рдХреЗ рд░реВрдк рдореЗрдВ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

### 3.2. рдЯреЗрд╕реНрдЯ рдлрд╝рд╛рдЗрд▓ stub рдЙрддреНрдкрдиреНрди рдХрд░реЗрдВ

рдкрд╣рд▓реЗ рдХреА рддрд░рд╣, рд╕рдмрд╕реЗ рдкрд╣рд▓реЗ рд╣рдо рдлрд╝рд╛рдЗрд▓ stub рдЙрддреНрдкрдиреНрди рдХрд░рддреЗ рд╣реИрдВ:

```bash
nf-test generate process modules/gatk/jointgenotyping/main.nf
```

??? success "рдХрдорд╛рдВрдб рдЖрдЙрдЯрдкреБрдЯ"

    ```console
    Load source file '/workspaces/training/nf4-science/genomics/modules/gatk/jointgenotyping/main.nf'
    Wrote process test file '/workspaces/training/nf4-science/genomics/tests/modules/gatk/jointgenotyping/main.nf.test'

    SUCCESS: Generated 1 test files.
    ```

рдпрд╣ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдЯреЗрд╕реНрдЯ stub рдЙрддреНрдкрдиреНрди рдХрд░рддрд╛ рд╣реИ:

```groovy title="tests/modules/gatk/jointgenotyping/main.nf.test" linenums="1"
nextflow_process {

    name "Test Process GATK_JOINTGENOTYPING"
    script "modules/gatk/jointgenotyping/main.nf"
    process "GATK_JOINTGENOTYPING"

    test("Should run without failures") {

        when {
            params {
                // define parameters here. Example:
                // outdir = "tests/results"
            }
            process {
                """
                // define inputs of the process here. Example:
                // input[0] = file("test-file.txt")
                """
            }
        }

        then {
            assert process.success
            assert snapshot(process.out).match()
        }

    }

}
```

### 3.3. рдЯреЗрд╕реНрдЯ рдлрд╝рд╛рдЗрд▓ рдХреЛ рд╕реНрдерд╛рдирд╛рдВрддрд░рд┐рдд рдХрд░реЗрдВ рдФрд░ script path рдХреЛ рдЕрдкрдбреЗрдЯ рдХрд░реЗрдВ

рдЗрд╕ рдмрд╛рд░ рд╣рдорд╛рд░реЗ рдкрд╛рд╕ рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рдореЙрдбреНрдпреВрд▓ рдХреА `main.nf` рдлрд╝рд╛рдЗрд▓ рдХреЗ рд╕рд╛рде co-located рдЯреЗрд╕реНрдЯ рдХреЗ рд▓рд┐рдП рдПрдХ рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рд╣реИ, рдЗрд╕рд▓рд┐рдП рд╣рдо рдЯреЗрд╕реНрдЯ stub рдлрд╝рд╛рдЗрд▓ рдХреЛ рд╡рд╣рд╛рдБ рд╕реНрдерд╛рдирд╛рдВрддрд░рд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:

```bash
mv tests/modules/gatk/jointgenotyping/main.nf.test modules/gatk/jointgenotyping/tests/
```

рдФрд░ script path рдХреЛ рдЕрдкрдбреЗрдЯ рдХрд░рдирд╛ рди рднреВрд▓реЗрдВ:

=== "рдмрд╛рдж рдореЗрдВ"

    ```groovy title="modules/gatk/jointgenotyping/tests/main.nf.test" linenums="3" hl_lines="2"
    name "Test Process GATK_JOINTGENOTYPING"
    script "../main.nf"
    process "GATK_JOINTGENOTYPING"
    ```

=== "рдкрд╣рд▓реЗ"

    ```groovy title="modules/gatk/jointgenotyping/tests/main.nf.test" linenums="3" hl_lines="2"
    name "Test Process GATK_JOINTGENOTYPING"
    script "modules/gatk/jointgenotyping/main.nf"
    process "GATK_JOINTGENOTYPING"
    ```

### 3.4. рдЗрдирдкреБрдЯ рдкреНрд░рджрд╛рди рдХрд░реЗрдВ

process input definitions рдХреЗ рдЖрдзрд╛рд░ рдкрд░ рдЗрдирдкреБрдЯ рднрд░реЗрдВ рдФрд░ рдЯреЗрд╕реНрдЯ рдХрд╛ рдирд╛рдо рддрджрдиреБрд╕рд╛рд░ рдмрджрд▓реЗрдВ:

```groovy title="modules/gatk/jointgenotyping/tests/main.nf.test" linenums="7"
    test("Should call trio's joint genotype correctly") {

        when {
            params {
                // define parameters here
            }
            process {
                """
                input[0] = [
                    file("${projectDir}/modules/gatk/jointgenotyping/tests/inputs/reads_father.bam.g.vcf"),
                    file("${projectDir}/modules/gatk/jointgenotyping/tests/inputs/reads_mother.bam.g.vcf"),
                    file("${projectDir}/modules/gatk/jointgenotyping/tests/inputs/reads_son.bam.g.vcf")
                ]
                input[1] = [
                    file("${projectDir}/modules/gatk/jointgenotyping/tests/inputs/reads_father.bam.g.vcf.idx"),
                    file("${projectDir}/modules/gatk/jointgenotyping/tests/inputs/reads_mother.bam.g.vcf.idx"),
                    file("${projectDir}/modules/gatk/jointgenotyping/tests/inputs/reads_son.bam.g.vcf.idx")
                ]
                input[2] = file("${projectDir}/data/ref/intervals.bed")
                input[3] = "family_trio"
                input[4] = file("${projectDir}/data/ref/ref.fasta")
                input[5] = file("${projectDir}/data/ref/ref.fasta.fai")
                input[6] = file("${projectDir}/data/ref/ref.dict")
                """
            }
        }
```

### 3.5. Content assertions рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ

joint genotyping рдЪрд░рдг рдХрд╛ рдЖрдЙрдЯрдкреБрдЯ рдПрдХ рдФрд░ VCF рдлрд╝рд╛рдЗрд▓ рд╣реИ, рдЗрд╕рд▓рд┐рдП рд╣рдо рдлрд┐рд░ рд╕реЗ content assertion рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдЬрд╛ рд░рд╣реЗ рд╣реИрдВред

```groovy title="modules/gatk/jointgenotyping/tests/main.nf.test" linenums="25"
    then {
        assert process.success
        assert path(process.out[0][0]).readLines().contains('#CHROM	POS	ID	REF	ALT	QUAL	FILTER	INFO	FORMAT	reads_father	reads_mother	reads_son')
        assert path(process.out[0][0]).readLines().contains('20_10037292_10066351	3480	.	C	CT	1625.89	.	AC=5;AF=0.833;AN=6;BaseQRankSum=0.220;DP=85;ExcessHet=0.0000;FS=2.476;MLEAC=5;MLEAF=0.833;MQ=60.00;MQRankSum=0.00;QD=21.68;ReadPosRankSum=-1.147e+00;SOR=0.487	GT:AD:DP:GQ:PL	0/1:15,16:31:99:367,0,375	1/1:0,18:18:54:517,54,0	1/1:0,26:26:78:756,78,0')
    }
```

рдЖрдЙрдЯрдкреБрдЯ рдлрд╝рд╛рдЗрд▓ рдореЗрдВ рдПрдХ рд╡рд┐рд╢рд┐рд╖реНрдЯ variant рдХреА рд╕рд╛рдордЧреНрд░реА рдХреА рдЬрд╛рдВрдЪ рдХрд░рдХреЗ, рдпрд╣ рдЯреЗрд╕реНрдЯ рд╕рддреНрдпрд╛рдкрд┐рдд рдХрд░рддрд╛ рд╣реИ рдХрд┐:

1. joint genotyping process рд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ рдЪрд▓рддрд╛ рд╣реИ
2. рдЖрдЙрдЯрдкреБрдЯ VCF рдореЗрдВ рд╕рд╣реА рдХреНрд░рдо рдореЗрдВ рд╕рднреА рддреАрди рдирдореВрдиреЗ рд╢рд╛рдорд┐рд▓ рд╣реИрдВ
3. рдПрдХ рд╡рд┐рд╢рд┐рд╖реНрдЯ variant рдХреЛ рд╕рд╣реА рддрд░реАрдХреЗ рд╕реЗ call рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ:
   - рдкреНрд░рддреНрдпреЗрдХ рдирдореВрдиреЗ рдХреЗ рд▓рд┐рдП рд╕рдЯреАрдХ genotypes (father рдХреЗ рд▓рд┐рдП 0/1, mother рдФрд░ son рдХреЗ рд▓рд┐рдП 1/1)
   - рд╕рд╣реА read depths рдФрд░ genotype qualities
   - Population-level рдЖрдВрдХрдбрд╝реЗ рдЬреИрд╕реЗ allele frequency (AF=0.833)

рд╣рдордиреЗ рдкреВрд░реА рдлрд╝рд╛рдЗрд▓ рдХреЛ snapshot рдирд╣реАрдВ рдХрд┐рдпрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдПрдХ рд╡рд┐рд╢рд┐рд╖реНрдЯ variant рдХреА рдЬрд╛рдВрдЪ рдХрд░рдХреЗ, рд╣рдо рдЖрд╢реНрд╡рд╕реНрдд рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ joint genotyping process рдЕрдкреЗрдХреНрд╖рд╛ рдХреЗ рдЕрдиреБрд╕рд╛рд░ рдХрд╛рдо рдХрд░ рд░рд╣реА рд╣реИред

### 3.6. рдЯреЗрд╕реНрдЯ рдЪрд▓рд╛рдПрдВ

```bash
nf-test test modules/gatk/jointgenotyping/tests/main.nf.test
```

??? success "рдХрдорд╛рдВрдб рдЖрдЙрдЯрдкреБрдЯ"

    ```console
    ЁЯЪА nf-test 0.9.3
    https://www.nf-test.com
    (c) 2021 - 2024 Lukas Forer and Sebastian Schoenherr


    Test Process GATK_JOINTGENOTYPING

      Test [ac2067de] 'Should call trio's joint genotype correctly' PASSED (53.827s)


    SUCCESS: Executed 1 tests in 53.837s
    ```

рдЯреЗрд╕реНрдЯ рдкрд╛рд╕ рд╣реЛ рдЬрд╛рддрд╛ рд╣реИ, рдпрд╣ рд╕рддреНрдпрд╛рдкрд┐рдд рдХрд░рддреЗ рд╣реБрдП рдХрд┐ рд╣рдорд╛рд░реА joint genotyping process рд╕рд╣реА рддрд░реАрдХреЗ рд╕реЗ:

1. рд╡реНрдпрдХреНрддрд┐рдЧрдд рдирдореВрдирд╛ VCFs рдХреЛ рдЬреЛрдбрд╝рддреА рд╣реИ
2. joint variant calling рдХрд░рддреА рд╣реИ
3. runs рдореЗрдВ consistent genotype calls рдХреЗ рд╕рд╛рде рдПрдХ multi-sample VCF рдЙрддреНрдкрдиреНрди рдХрд░рддреА рд╣реИ

### рдирд┐рд╖реНрдХрд░реНрд╖

рдЖрдк рдЬрд╛рдирддреЗ рд╣реИрдВ рдХрд┐ рдХреИрд╕реЗ:

- рдЯреЗрд╕реНрдЯ рдХреЗ рд▓рд┐рдП рдЗрдирдкреБрдЯ рдХреЗ рд░реВрдк рдореЗрдВ рдкрд╣рд▓реЗ рд╕реЗ рдЙрддреНрдкрдиреНрди рдкрд░рд┐рдгрд╛рдореЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ
- Pre-generated рдЯреЗрд╕реНрдЯ рдбреЗрдЯрд╛ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЯреЗрд╕реНрдЯ рд▓рд┐рдЦреЗрдВ

### рдЖрдЧреЗ рдХреНрдпрд╛ рд╣реИ?

рдкреВрд░реА variant calling pipeline end-to-end рд╕рд╣реА рддрд░реАрдХреЗ рд╕реЗ рдХрд╛рдо рдХрд░рддреА рд╣реИ рдпрд╣ рд╕рддреНрдпрд╛рдкрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ workflow-level рдЯреЗрд╕реНрдЯ рдЬреЛрдбрд╝реЗрдВред

---

## 4. рдПрдХ workflow-level рдЯреЗрд╕реНрдЯ рдЬреЛрдбрд╝реЗрдВ

рдЕрдм рд╣рдо рдкреВрд░реА variant calling pipeline рдХреЛ рдЯреЗрд╕реНрдЯ рдХрд░реЗрдВрдЧреЗ, BAM рдлрд╝рд╛рдЗрд▓реЛрдВ рд╕реЗ рд▓реЗрдХрд░ joint genotypes рддрдХред рдпрд╣ рд╕рддреНрдпрд╛рдкрд┐рдд рдХрд░рддрд╛ рд╣реИ рдХрд┐:

1. рд╕рднреА processes рдПрдХ рд╕рд╛рде рд╕рд╣реА рддрд░реАрдХреЗ рд╕реЗ рдХрд╛рдо рдХрд░рддреА рд╣реИрдВ
2. рдбреЗрдЯрд╛ рдЪрд░рдгреЛрдВ рдХреЗ рдмреАрдЪ рдЙрдЪрд┐рдд рд░реВрдк рд╕реЗ flow рдХрд░рддрд╛ рд╣реИ
3. рдЕрдВрддрд┐рдо variant calls consistent рд╣реИрдВ

### 4.1. workflow рдЯреЗрд╕реНрдЯ рдЙрддреНрдкрдиреНрди рдХрд░реЗрдВ

рдкреВрд░реА pipeline рдХреЗ рд▓рд┐рдП рдПрдХ рдЯреЗрд╕реНрдЯ рдлрд╝рд╛рдЗрд▓ рдЙрддреН
